<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TaskFlow - Task Management</title>
    
    <!-- Mobile App Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TaskFlow">
    <meta name="application-name" content="TaskFlow">
    <meta name="msapplication-TileColor" content="#1e293b">
    <meta name="theme-color" content="#1e293b">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%231e293b;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%233b82f6;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' fill='url(%23grad)' rx='20'/%3E%3Cg fill='white'%3E%3Crect x='20' y='25' width='60' height='8' rx='4'/%3E%3Crect x='20' y='40' width='45' height='6' rx='3'/%3E%3Crect x='20' y='52' width='50' height='6' rx='3'/%3E%3Ccircle cx='15' cy='29' r='3'/%3E%3Ccircle cx='15' cy='43' r='3'/%3E%3Ccircle cx='15' cy='55' r='3'/%3E%3Cpath d='M15 67 L25 77 L35 67' stroke='white' stroke-width='3' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/g%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Cache buster: v6.0 - Mobile App */
        
        /* Mobile App Styles */
        html, body {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        /* iOS Safe Area Support */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(12px, env(safe-area-inset-left));
                padding-right: max(12px, env(safe-area-inset-right));
            }
            .mobile-header {
                padding-top: max(1rem, env(safe-area-inset-top));
            }
        }
        
        /* Prevent zoom on input focus */
        input, select, textarea {
            font-size: 16px !important;
        }
        
        /* Smooth scrolling */
        * {
            -webkit-overflow-scrolling: touch;
        }
        
        /* Desktop notification button hide on mobile */
        @media (max-width: 768px) {
            #desktop-notification-btn { display: none !important; }
            #test-notification-btn { display: none !important; }
            #notification-center { 
                width: 90vw !important; 
                right: 5vw !important; 
                top: 70px !important;
                max-height: 70vh !important;
            }
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #f8fafc; }
        
        /* Comments Styles */
        .comments-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .comments-list::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        
        .comments-list::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        /* Kanban Board Styles */
        .kanban-task:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        
        .kanban-task:active {
            cursor: grabbing;
        }
        
        .kanban-column .kanban-tasks {
            border: 2px dashed transparent;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .kanban-column .kanban-tasks:hover {
            border-color: #e2e8f0;
        }
        
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            #kanban-board {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            .kanban-column {
                margin-bottom: 1rem;
            }
            
            .kanban-tasks {
                min-height: 200px !important;
            }
            body { padding-top: 70px; }
            .mobile-header { display: block !important; }
            .sidebar { 
                position: fixed;
                left: -320px;
                top: 0;
                height: 100vh;
                width: 320px;
                z-index: 1000;
                transition: left 0.3s;
            }
            .sidebar.show {
                left: 0;
            }
            .main-content {
                padding: 1rem;
                padding-top: 1rem;
            }
            .dashboard-header h1 { font-size: 1.75rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 1rem; }
            .stat-card { padding: 1rem; }
            .stat-icon { width: 45px; height: 45px; font-size: 1.1rem; }
            .stat-content h3 { font-size: 1.5rem; }
            
            /* Dashboard stat cards - match Tasks page exactly */
            #dashboard-view .stats-grid {
                margin-bottom: 1rem !important;
            }
            #dashboard-view .stat-card {
                padding: 1rem !important;
            }
            #dashboard-view .stat-content h3 {
                font-size: 1.5rem !important;
            }
            #dashboard-view .stat-content p {
                font-size: 0.8rem !important;
            }
            
            /* Mobile Analytics */
            .charts-row { grid-template-columns: 1fr !important; }
            .timeline-row { grid-template-columns: 1fr !important; }
            .stats-grid { grid-template-columns: repeat(2, 1fr) !important; }
            .dashboard-charts { grid-template-columns: 1fr !important; }
            
            /* Mobile Tasks View Fix */
            #tasks-view .stats-grid {
                margin-bottom: 1rem !important;
            }
            #tasks-view .stat-card {
                padding: 1rem !important;
            }
            #tasks-view .stat-content h3 {
                font-size: 1.5rem !important;
            }
            #tasks-view .stat-content p {
                font-size: 0.8rem !important;
            }
            
            /* Mobile Dashboard Recent Tasks - Fix overflow and sizing */
            #recent-tasks {
                overflow-x: hidden !important;
            }
            #recent-tasks div[style*="padding: 16px"] {
                padding: 12px !important;
                margin-bottom: 8px !important;
            }
            #recent-tasks span[style*="font-size: 0.75rem"] {
                font-size: 0.7rem !important;
            }
            #recent-tasks div[style*="display: flex; flex-wrap: wrap; gap: 6px;"] {
                gap: 4px !important;
            }
            #recent-tasks div[style*="display: flex; justify-content: space-between; align-items: flex-start;"] {
                flex-wrap: wrap !important;
                gap: 0.5rem !important;
            }
            .btn-text {
                display: none !important;
            }
            
            /* Mobile Tasks View - Fix horizontal scroll */
            .main-content {
                overflow-x: hidden !important;
            }
            .mobile-header-actions {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 1rem !important;
            }
            .mobile-header-actions h3 {
                text-align: center !important;
                margin: 0 !important;
            }
            .mobile-buttons {
                justify-content: center !important;
                flex-wrap: wrap !important;
            }
            /* Fix task card overflow */
            [style*="display: flex; justify-content: space-between; align-items: center;"] {
                flex-wrap: wrap !important;
                gap: 0.5rem !important;
            }
            [style*="display: flex; gap: 8px;"] {
                flex-wrap: wrap !important;
                gap: 4px !important;
            }
            
            /* Mobile Calendar - List View */
            .year-grid { 
                grid-template-columns: 1fr !important;
                gap: 0.75rem !important;
            }
            .year-grid > div {
                padding: 1.25rem !important;
                border-radius: 12px !important;
            }
            .year-grid > div h3 {
                font-size: 1.1rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            /* Mobile Calendar - Proper 7-day grid */
            #calendar-container {
                overflow-x: auto !important;
                width: 100% !important;
                min-width: 320px !important;
            }
            .calendar-header {
                display: grid !important;
                grid-template-columns: repeat(7, 1fr) !important;
                gap: 1px !important;
                margin-bottom: 1px !important;
                width: 100% !important;
                min-width: 320px !important;
            }
            .calendar-header div {
                padding: 8px 2px !important;
                font-size: 0.75rem !important;
                text-align: center !important;
                min-width: 44px !important;
                background: #1e293b !important;
                color: white !important;
                font-weight: 600 !important;
            }
            .calendar-grid {
                width: 100% !important;
                min-width: 320px !important;
                background: #e2e8f0 !important;
            }
            .calendar-grid > div {
                display: grid !important;
                grid-template-columns: repeat(7, 1fr) !important;
                gap: 1px !important;
                margin-bottom: 1px !important;
                width: 100% !important;
            }
            .calendar-grid > div > div {
                min-height: 60px !important;
                padding: 4px 2px !important;
                font-size: 0.75rem !important;
                border: none !important;
                min-width: 44px !important;
                background: white !important;
                overflow: hidden !important;
                position: relative !important;
            }
            .calendar-grid > div > div > div:first-child {
                font-size: 0.75rem !important;
                font-weight: 600 !important;
                line-height: 1.2 !important;
                margin-bottom: 2px !important;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr; }
            .dashboard-header h1 { font-size: 1.5rem; }
            .main-content { padding: 0.75rem; }
            
            /* Compact mobile calendar */
            .calendar-grid > div > div {
                min-height: 50px !important;
                font-size: 0.7rem !important;
                padding: 3px 1px !important;
                min-width: 40px !important;
            }
            .calendar-header div {
                padding: 6px 1px !important;
                font-size: 0.7rem !important;
                min-width: 40px !important;
            }
            .calendar-grid > div > div > div:first-child {
                font-size: 0.7rem !important;
            }
            #calendar-container {
                min-width: 290px !important;
            }
            .calendar-header, .calendar-grid {
                min-width: 290px !important;
            }
            
            /* Mobile task cards - Apply to all task cards */
            div[style*="padding: 16px"] {
                padding: 12px !important;
                margin-bottom: 8px !important;
            }
            span[style*="font-size: 0.75rem"] {
                font-size: 0.7rem !important;
            }
            div[style*="display: flex; flex-wrap: wrap; gap: 6px;"] {
                gap: 4px !important;
            }
            div[style*="display: flex; justify-content: space-between; align-items: flex-start;"] {
                flex-wrap: wrap !important;
                gap: 0.5rem !important;
            }
            .btn-text {
                display: none !important;
            }
        }
        
        /* Calendar Mobile Styles */
        @media (max-width: 768px) {
            .year-grid { grid-template-columns: repeat(3, 1fr) !important; }
            .calendar-grid > div > div { min-height: 70px !important; font-size: 0.875rem; }
        }
        
        .auth-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; 
        }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f8fafc; display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .loading-spinner {
            width: 50px; height: 50px; border: 4px solid #e2e8f0;
            border-top: 4px solid #3b82f6; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .auth-content { 
            background: white; padding: 2rem; border-radius: 12px; text-align: center; 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); max-width: 400px; width: 90%;
        }
        .btn-google { 
            background: white; border: 1px solid #dadce0; padding: 12px 24px; 
            border-radius: 8px; cursor: pointer; display: flex; align-items: center; 
            justify-content: center; gap: 8px; width: 100%; margin-top: 1rem;
        }
        .btn-google:hover { background: #f8f9fa; }
        
        .app { display: none; min-height: 100vh; }
        .app.show { display: flex; }
        
        .sidebar { 
            width: 280px; background: #1e293b; color: white; padding: 1.5rem; 
            display: flex; flex-direction: column;
        }
        .sidebar nav { margin-top: 0; }
        .sidebar .logo { margin-bottom: 2rem; }
        .logo { font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; }
        .nav-link { 
            display: flex; align-items: center; gap: 12px; padding: 12px; 
            color: rgba(255,255,255,0.8); text-decoration: none; border-radius: 8px; 
            margin-bottom: 4px; transition: all 0.2s;
        }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: white; }
        
        .main-content { flex: 1; padding: 2rem; }
        .dashboard-header { text-align: center; margin-bottom: 2rem; }
        .dashboard-header h1 { font-size: 2.5rem; color: #1e293b; margin-bottom: 0.5rem; }
        
        .stats-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 1.5rem; margin-bottom: 2rem; 
        }
        .stat-card { 
            background: white; padding: 1.5rem; border-radius: 12px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 1rem;
            position: relative; overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }
        .stat-card:hover::before {
            left: 100%;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .stat-icon { 
            width: 60px; height: 60px; border-radius: 12px; display: flex; 
            align-items: center; justify-content: center; font-size: 1.5rem; color: white;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .stat-content h3 { 
            font-size: 2rem; color: #1e293b; 
            font-weight: 700; 
            background: linear-gradient(135deg, #1e293b, #475569);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stat-content p { color: #64748b; font-weight: 500; }
        
        .user-info { 
            margin-top: auto; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; gap: 12px;
        }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: #3b82f6; }
        .logout-btn { 
            position: fixed; top: 20px; right: 20px; z-index: 1000;
            background: #ef4444; color: white; border: none; padding: 8px 16px; 
            border-radius: 6px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        @media (max-width: 768px) {
            .logout-btn { display: none; }
        }
        
        .view { display: none; }
        .view.active { display: block; }
        
        /* Notification Styles */
        .notification {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            max-width: 400px;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        .notification.success { border-left: 4px solid #10b981; }
        .notification.error { border-left: 4px solid #ef4444; }
        .notification.warning { border-left: 4px solid #f59e0b; }
        .notification.info { border-left: 4px solid #3b82f6; }
        .notification-icon {
            font-size: 1.25rem;
        }
        .notification.success .notification-icon { color: #10b981; }
        .notification.error .notification-icon { color: #ef4444; }
        .notification.warning .notification-icon { color: #f59e0b; }
        .notification.info .notification-icon { color: #3b82f6; }
        .notification-content {
            flex: 1;
        }
        .notification-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 2px;
        }
        .notification-message {
            color: #64748b;
            font-size: 0.875rem;
        }
        .notification-close {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }
        .notification-close:hover {
            background: #f3f4f6;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <p style="margin-top: 1rem; color: #64748b;">Loading TaskManager...</p>
        </div>
    </div>
    
    <div id="auth-modal" class="auth-modal" style="display: none;">
        <div class="auth-content">
            <h2>Welcome to TaskManager</h2>
            <p>Sign in to manage your tasks</p>
            <button id="google-login" class="btn-google">
                <i class="fab fa-google"></i>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" style="position: fixed; top: 20px; right: 20px; z-index: 10000;"></div>
    
    <div id="app" class="app">
        <div class="mobile-header" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: white; padding: 1rem; border-bottom: 1px solid #e2e8f0; z-index: 999;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button id="mobile-menu-btn" style="background: none; border: none; font-size: 1.5rem; color: #1e293b; cursor: pointer;">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 style="margin: 0; color: #1e293b;">TaskManager</h2>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button id="notification-btn" style="background: none; border: none; font-size: 1.5rem; color: #1e293b; cursor: pointer; position: relative; padding: 8px;">
                        <i class="fas fa-bell"></i>
                        <span id="notification-badge" style="position: absolute; top: 0px; right: 0px; background: #ef4444; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; display: none;">0</span>
                    </button>
                    <button id="install-app-btn" style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.875rem; display: none;">
                        <i class="fas fa-download"></i>
                    </button>
                    <button id="mobile-logout-btn" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="sidebar" id="sidebar">
            <div class="logo">
                <i class="fas fa-tasks"></i> TaskManager
            </div>
            <nav>
                <a href="#" class="nav-link active" data-view="dashboard">
                    <i class="fas fa-tachometer-alt"></i> <span>Dashboard</span>
                </a>
                <a href="#" class="nav-link" data-view="kanban">
                    <i class="fas fa-columns"></i> <span>Kanban</span>
                </a>
                <a href="#" class="nav-link" data-view="tasks">
                    <i class="fas fa-list"></i> <span>All Tasks</span>
                </a>
                <a href="#" class="nav-link" data-view="my-tasks">
                    <i class="fas fa-user-check"></i> <span>My Tasks</span>
                </a>
                <a href="#" class="nav-link" data-view="calendar">
                    <i class="fas fa-calendar-alt"></i> <span>Calendar</span>
                </a>
                <a href="#" class="nav-link" data-view="projects">
                    <i class="fas fa-project-diagram"></i> <span>Projects</span>
                </a>
                <a href="#" class="nav-link" data-view="analytics">
                    <i class="fas fa-chart-bar"></i> <span>Analytics</span>
                </a>

                <a href="#" class="nav-link" data-view="users" id="users-nav" style="display: none;">
                    <i class="fas fa-users"></i> <span>Users</span>
                </a>
            </nav>
            <div class="user-info">
                <div class="user-avatar" id="user-avatar"></div>
                <div>
                    <div id="user-name">User</div>
                    <div id="user-email" style="font-size: 0.8rem; opacity: 0.7;"></div>
                </div>
            </div>
        </div>
        
        <!-- Desktop Notification Button -->
        <button id="desktop-notification-btn" style="position: fixed; top: 20px; right: 140px; background: white; border: 1px solid #e2e8f0; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 1000; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: #1e293b;">
            <i class="fas fa-bell"></i>
            <span id="desktop-notification-badge" style="position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; display: none;">0</span>
        </button>
        
        <!-- Desktop Logout Button -->
        <button id="logout-btn" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
        

        
        <div class="main-content">
            <div id="dashboard-view" class="view active">
                <div class="dashboard-header">
                    <h1>Dashboard</h1>
                    <p id="welcome-message">Welcome back! Here's your task overview.</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card" onclick="showTasksByFilter('all')" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="total-tasks">0</h3>
                            <p>Total Tasks</p>
                        </div>
                    </div>
                    <div class="stat-card" onclick="showTasksByFilter('scheduled')" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="scheduled-tasks">0</h3>
                            <p>Scheduled</p>
                        </div>
                    </div>
                    <div class="stat-card" onclick="showTasksByFilter('in-progress')" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #fbbf24, #f59e0b);">
                            <i class="fas fa-spinner"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="inprogress-tasks">0</h3>
                            <p>In Progress</p>
                        </div>
                    </div>
                    <div class="stat-card" onclick="showTasksByFilter('completed')" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="completed-tasks">0</h3>
                            <p>Completed</p>
                        </div>
                    </div>
                </div>
                
                <!-- Deadline Alerts -->
                <div id="deadline-alerts" style="margin-bottom: 2rem;"></div>
                
                <!-- Charts Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;" class="dashboard-charts">
                    <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 1rem; color: #1e293b;">Task Status</h3>
                        <div style="position: relative; height: 200px;">
                            <canvas id="dashboard-status-chart"></canvas>
                        </div>
                    </div>
                    <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 1rem; color: #1e293b;">Overdue Tasks</h3>
                        <div style="position: relative; height: 200px;">
                            <canvas id="dashboard-overdue-chart"></canvas>
                        </div>
                    </div>
                    <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 1rem; color: #1e293b;">Priority Breakdown</h3>
                        <div style="position: relative; height: 200px;">
                            <canvas id="dashboard-priority-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 1rem;">Recent Tasks</h3>
                    <div id="recent-tasks">
                        <p style="color: #64748b; text-align: center; padding: 2rem;">No tasks yet. Start by creating your first task!</p>
                    </div>
                </div>
            </div>
            
            <div id="tasks-view" class="view">
                <div class="dashboard-header">
                    <h1>Tasks</h1>
                    <p>Manage your tasks efficiently</p>
                </div>
                
                <!-- Task Stats Cards -->
                <div class="stats-grid" style="margin-bottom: 1.5rem;">
                    <div class="stat-card" onclick="showTasksByFilter('all')" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="tasks-total">0</h3>
                            <p>Total</p>
                        </div>
                    </div>
                    <div class="stat-card" onclick="showTasksByFilter('scheduled')" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="tasks-scheduled">0</h3>
                            <p>Scheduled</p>
                        </div>
                    </div>
                    <div class="stat-card" onclick="showTasksByFilter('in-progress')" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #fbbf24, #f59e0b);">
                            <i class="fas fa-spinner"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="tasks-inprogress">0</h3>
                            <p>In Progress</p>
                        </div>
                    </div>
                    <div class="stat-card" onclick="showTasksByFilter('completed')" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="tasks-completed">0</h3>
                            <p>Completed</p>
                        </div>
                    </div>
                </div>
                
                <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div class="mobile-header-actions" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 id="tasks-filter-title">All Tasks</h3>
                        <div class="mobile-buttons" style="display: flex; gap: 8px;">
                            <button onclick="openBulkImportModal()" style="background: #10b981; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
                                <i class="fas fa-upload"></i> <span class="btn-text">Import</span>
                            </button>
                            <button id="add-task-btn" style="background: #3b82f6; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
                                <i class="fas fa-plus"></i> <span class="btn-text">Add</span>
                            </button>
                        </div>
                    </div>
                    <div id="tasks-list">
                        <p style="color: #64748b; text-align: center; padding: 2rem;">No tasks yet. Create your first task!</p>
                    </div>
                </div>
            </div>
            
            <div id="projects-view" class="view">
                <div class="dashboard-header">
                    <h1>Projects</h1>
                    <p>Organize your work into projects</p>
                </div>
                
                <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div class="mobile-header-actions" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3>All Projects</h3>
                        <button id="add-project-btn" style="background: #3b82f6; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
                            <i class="fas fa-plus"></i> <span class="btn-text">Add</span>
                        </button>
                    </div>
                    <div id="projects-list">
                        <p style="color: #64748b; text-align: center; padding: 2rem;">No projects yet. Create your first project!</p>
                    </div>
                </div>
            </div>
            
            <div id="kanban-view" class="view">
                <div class="dashboard-header">
                    <h1>Kanban Board</h1>
                    <p>Drag and drop your tasks</p>
                </div>
                
                <div id="kanban-board" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; min-height: 500px;">
                    <!-- Scheduled Column -->
                    <div class="kanban-column" data-status="scheduled" style="background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1rem;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #f093fb;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #f093fb;"></div>
                            <h3 style="color: #1e293b; margin: 0;">Scheduled</h3>
                            <span class="task-count" style="background: #f093fb; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">0</span>
                        </div>
                        <div class="kanban-tasks" style="min-height: 400px;"></div>
                    </div>
                    
                    <!-- In Progress Column -->
                    <div class="kanban-column" data-status="in-progress" style="background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1rem;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #fbbf24;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #fbbf24;"></div>
                            <h3 style="color: #1e293b; margin: 0;">In Progress</h3>
                            <span class="task-count" style="background: #fbbf24; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">0</span>
                        </div>
                        <div class="kanban-tasks" style="min-height: 400px;"></div>
                    </div>
                    
                    <!-- Completed Column -->
                    <div class="kanban-column" data-status="completed" style="background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1rem;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #4facfe;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #4facfe;"></div>
                            <h3 style="color: #1e293b; margin: 0;">Completed</h3>
                            <span class="task-count" style="background: #4facfe; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">0</span>
                        </div>
                        <div class="kanban-tasks" style="min-height: 400px;"></div>
                    </div>
                </div>
            </div>
            
            <div id="list-view" class="view">
                <div class="dashboard-header">
                    <h1>List View</h1>
                    <p>View all tasks in a list format</p>
                </div>
                <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <p style="color: #64748b; text-align: center; padding: 2rem;">List view functionality coming soon!</p>
                </div>
            </div>
            
            <div id="calendar-view" class="view">
                <div class="dashboard-header">
                    <h1>Calendar</h1>
                    <p>View tasks by due dates</p>
                </div>
                <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div id="calendar-container" style="min-height: 500px;"></div>
                </div>
            </div>
            
            <div id="analytics-view" class="view">
                <div class="dashboard-header">
                    <h1>Analytics</h1>
                    <p>Task performance and insights</p>
                </div>
                
                <!-- Key Metrics -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;" id="completion-rate">0%</div>
                        <div style="opacity: 0.9;">Completion Rate</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;" id="avg-completion-time">0d</div>
                        <div style="opacity: 0.9;">Avg Completion</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;" id="overdue-tasks">0</div>
                        <div style="opacity: 0.9;">Overdue Tasks</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #43e97b, #38f9d7); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;" id="productivity-score">0</div>
                        <div style="opacity: 0.9;">Productivity Score</div>
                    </div>
                </div>
                
                <!-- Charts Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;" class="charts-row">
                    <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 1rem; color: #1e293b;">Task Status Distribution</h3>
                        <div style="position: relative; height: 250px;">
                            <canvas id="status-chart"></canvas>
                        </div>
                    </div>
                    <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 1rem; color: #1e293b;">Priority Breakdown</h3>
                        <div style="position: relative; height: 250px;">
                            <canvas id="priority-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Timeline and Project Charts -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 2rem;" class="timeline-row">
                    <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 1rem; color: #1e293b;">Task Completion Timeline</h3>
                        <div style="position: relative; height: 250px;">
                            <canvas id="timeline-chart"></canvas>
                        </div>
                    </div>
                    <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 1rem; color: #1e293b;">Project Progress</h3>
                        <div id="project-progress" style="max-height: 250px; overflow-y: auto;"></div>
                    </div>
                </div>
                
                <!-- Performance Insights -->
                <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 1rem; color: #1e293b;">Performance Insights</h3>
                    <div id="insights-list"></div>
                </div>
            </div>
            
            <!-- Notification Center Dropdown -->
            <div id="notification-center" style="position: fixed; top: 80px; right: 20px; width: 400px; max-height: 500px; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); z-index: 1001; display: none; overflow: hidden;">
                <div style="padding: 1rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; color: #1e293b;">Notifications</h3>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="clearAllNotifications()" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button onclick="toggleNotificationCenter()" style="background: none; border: none; color: #64748b; cursor: pointer; font-size: 1.2rem;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div id="notifications-list" style="max-height: 400px; overflow-y: auto; padding: 0.5rem;">
                    <p style="color: #64748b; text-align: center; padding: 2rem;">No notifications yet.</p>
                </div>
            </div>
            
            <div id="my-tasks-view" class="view">
                <div class="dashboard-header">
                    <h1>My Tasks</h1>
                    <p>Tasks assigned to you</p>
                </div>
                
                <!-- My Task Stats Cards -->
                <div class="stats-grid" style="margin-bottom: 1.5rem;">
                    <div class="stat-card" onclick="showMyTasksByFilter('all')" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="my-tasks-total">0</h3>
                            <p>Total</p>
                        </div>
                    </div>
                    <div class="stat-card" onclick="showMyTasksByFilter('scheduled')" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="my-tasks-scheduled">0</h3>
                            <p>Scheduled</p>
                        </div>
                    </div>
                    <div class="stat-card" onclick="showMyTasksByFilter('in-progress')" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #fbbf24, #f59e0b);">
                            <i class="fas fa-spinner"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="my-tasks-inprogress">0</h3>
                            <p>In Progress</p>
                        </div>
                    </div>
                    <div class="stat-card" onclick="showMyTasksByFilter('completed')" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="my-tasks-completed">0</h3>
                            <p>Completed</p>
                        </div>
                    </div>
                </div>
                
                <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div class="mobile-header-actions" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 id="my-tasks-filter-title">My Tasks</h3>
                    </div>
                    <div id="my-tasks-list">
                        <p style="color: #64748b; text-align: center; padding: 2rem;">No tasks assigned to you yet.</p>
                    </div>
                </div>
            </div>
            
            <div id="users-view" class="view">
                <div class="dashboard-header">
                    <h1>User Management</h1>
                    <p>Manage team members and their roles</p>
                </div>
                
                <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3>Team Members</h3>
                        <div class="mobile-buttons" style="display: flex; gap: 8px;">
                            <button onclick="initializeUsers()" style="background: #10b981; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
                                <i class="fas fa-sync"></i> <span class="btn-text">Init</span>
                            </button>
                            <button onclick="openUserModal()" style="background: #3b82f6; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
                                <i class="fas fa-plus"></i> <span class="btn-text">Add</span>
                            </button>
                        </div>
                    </div>
                    <div id="users-list">
                        <p style="color: #64748b; text-align: center; padding: 2rem;">Loading users...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="js/config.js?v=5.2"></script>
    <script>
        // Initialize Firebase
        firebase.initializeApp(window.firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        let currentUser = null;
        let currentUserData = null;
        let tasks = [];
        let projects = [];
        let availableUsers = [];
        let allUsers = [];

        // DOM elements
        const authModal = document.getElementById('auth-modal');
        const app = document.getElementById('app');
        const googleLoginBtn = document.getElementById('google-login');
        const logoutBtn = document.getElementById('logout-btn');

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
        
        // PWA Install
        let deferredPrompt;
        let canInstall = false;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            canInstall = true;
            document.getElementById('install-app-btn').style.display = 'block';
        });
        
        // Check if already installed
        window.addEventListener('appinstalled', () => {
            document.getElementById('install-app-btn').style.display = 'none';
            deferredPrompt = null;
            canInstall = false;
        });
        
        // Show button if PWA criteria might be met
        window.addEventListener('load', () => {
            setTimeout(() => {
                if ('serviceWorker' in navigator && window.matchMedia('(display-mode: browser)').matches) {
                    document.getElementById('install-app-btn').style.display = 'block';
                }
            }, 2000);
        });
        
        document.getElementById('install-app-btn').addEventListener('click', async () => {
            if (deferredPrompt && canInstall) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('install-app-btn').style.display = 'none';
                }
                deferredPrompt = null;
                canInstall = false;
            } else {
                // Try to trigger install for browsers that support it
                if ('BeforeInstallPromptEvent' in window) {
                    // Browser supports PWA but event hasn't fired yet
                    alert('Please wait a moment and try again, or use browser menu to install.');
                } else {
                    // Manual install instructions
                    alert('To install this app:\n\n• Chrome: Menu (⋮) → "Add to Home screen"\n• Safari: Share (□↗) → "Add to Home Screen"\n• Firefox: Menu (⋮) → "Install"');
                }
            }
        });
        
        // Event listeners
        googleLoginBtn.addEventListener('click', handleGoogleLogin);
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        document.getElementById('mobile-logout-btn').addEventListener('click', handleLogout);
        
        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const view = e.currentTarget.dataset.view;
                showView(view);
                // Close mobile menu after navigation
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.remove('show');
            });
        });
        
        // Add task/project buttons
        document.addEventListener('click', (e) => {
            if (e.target.id === 'add-task-btn' || e.target.closest('#add-task-btn')) {
                openTaskModal();
            }
            if (e.target.id === 'add-project-btn' || e.target.closest('#add-project-btn')) {
                openProjectModal();
            }
        });
        
        // Mobile menu toggle
        document.addEventListener('click', (e) => {
            if (e.target.id === 'mobile-menu-btn' || e.target.closest('#mobile-menu-btn')) {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('show');
            }
            // Close sidebar when clicking outside
            if (!e.target.closest('.sidebar') && !e.target.closest('#mobile-menu-btn')) {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.remove('show');
            }
        });

        // Authentication functions
        async function handleGoogleLogin() {
            try {
                console.log('Starting Google login...');
                const result = await auth.signInWithPopup(googleProvider);
                console.log('Login successful:', result.user.email);
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed: ' + error.message);
            }
        }

        async function handleLogout() {
            try {
                await auth.signOut();
                console.log('Logged out successfully');
            } catch (error) {
                console.error('Logout error:', error);
            }
        }


        
        // Auth state listener
        auth.onAuthStateChanged(async (user) => {
            console.log('Auth state changed:', user ? 'logged in' : 'logged out');
            
            // Hide loading overlay
            document.getElementById('loading-overlay').style.display = 'none';
            
            if (user) {
                currentUser = user;
                
                // Update UI
                document.getElementById('user-name').textContent = user.displayName || user.email.split('@')[0];
                document.getElementById('user-email').textContent = user.email;
                
                if (user.photoURL) {
                    document.getElementById('user-avatar').style.backgroundImage = `url(${user.photoURL})`;
                    document.getElementById('user-avatar').style.backgroundSize = 'cover';
                } else {
                    const initials = (user.displayName || user.email).charAt(0).toUpperCase();
                    document.getElementById('user-avatar').textContent = initials;
                    document.getElementById('user-avatar').style.display = 'flex';
                    document.getElementById('user-avatar').style.alignItems = 'center';
                    document.getElementById('user-avatar').style.justifyContent = 'center';
                    document.getElementById('user-avatar').style.color = 'white';
                    document.getElementById('user-avatar').style.fontWeight = 'bold';
                }
                
                // Hide auth modal and show app
                authModal.style.display = 'none';
                app.classList.add('show');
                
                // Load user data
                await loadCurrentUserData();
                await loadTasks();
                await loadProjects();
                await loadUsers();
                await loadAllUsers();
                updateStats();
                
                // Show user management for admins
                if (currentUserData?.role === 'Admin') {
                    document.getElementById('users-nav').style.display = 'block';
                }
                
                // Update welcome message with user role
                updateWelcomeMessage();
                
                // Setup notifications with debug logging
                console.log('Setting up notifications for user:', user.uid, 'on platform:', navigator.userAgent.includes('Mobile') ? 'mobile' : 'desktop');
                setupNotificationListener();
                await requestNotificationPermission();
                
                // Force notification system initialization on desktop
                if (!navigator.userAgent.includes('Mobile')) {
                    console.log('Desktop detected, forcing notification system check');
                    setTimeout(() => {
                        console.log('Desktop notification system status check');
                        if (notificationListener) {
                            console.log('Notification listener is active on desktop');
                        } else {
                            console.log('Notification listener failed on desktop, retrying...');
                            setupNotificationListener();
                        }
                    }, 3000);
                }
                
            } else {
                currentUser = null;
                if (notificationListener) {
                    notificationListener();
                    notificationListener = null;
                }
                authModal.style.display = 'flex';
                app.classList.remove('show');
            }
        });

        // Data functions
        async function loadTasks() {
            try {
                if (!currentUser) return;
                
                // Load all tasks for team collaboration
                const snapshot = await db.collection('tasks').get();
                
                tasks = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                console.log('Loaded tasks:', tasks.length);
                renderRecentTasks();
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }

        async function loadProjects() {
            try {
                if (!currentUser) return;
                
                // Load all projects for team collaboration
                const snapshot = await db.collection('projects').get();
                
                projects = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                console.log('Loaded projects:', projects.length);
            } catch (error) {
                console.error('Error loading projects:', error);
            }
        }

        function animateCounter(element, target, duration = 1000) {
            const start = 0;
            const increment = target / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    element.textContent = target;
                    clearInterval(timer);
                } else {
                    element.textContent = Math.floor(current);
                }
            }, 16);
        }
        
        function updateStats() {
            const totalTasks = tasks.length;
            const scheduledTasks = tasks.filter(task => task.status === 'scheduled' || task.status === 'pending' || !task.status).length;
            const inProgressTasks = tasks.filter(task => task.status === 'in-progress').length;
            const completedTasks = tasks.filter(task => task.status === 'completed').length;
            
            // My tasks stats
            const myTasks = tasks.filter(task => task.assignee === currentUser?.email);
            const myTotalTasks = myTasks.length;
            const myScheduledTasks = myTasks.filter(task => task.status === 'scheduled' || task.status === 'pending' || !task.status).length;
            const myInProgressTasks = myTasks.filter(task => task.status === 'in-progress').length;
            const myCompletedTasks = myTasks.filter(task => task.status === 'completed').length;
            
            // Animate dashboard stats
            const totalEl = document.getElementById('total-tasks');
            const scheduledEl = document.getElementById('scheduled-tasks');
            const inProgressEl = document.getElementById('inprogress-tasks');
            const completedEl = document.getElementById('completed-tasks');
            
            if (totalEl) animateCounter(totalEl, totalTasks);
            if (scheduledEl) animateCounter(scheduledEl, scheduledTasks);
            if (inProgressEl) animateCounter(inProgressEl, inProgressTasks);
            if (completedEl) animateCounter(completedEl, completedTasks);
            
            // Update tasks page stats
            const tasksTotalEl = document.getElementById('tasks-total');
            const tasksScheduledEl = document.getElementById('tasks-scheduled');
            const tasksInProgressEl = document.getElementById('tasks-inprogress');
            const tasksCompletedEl = document.getElementById('tasks-completed');
            
            if (tasksTotalEl) animateCounter(tasksTotalEl, totalTasks);
            if (tasksScheduledEl) animateCounter(tasksScheduledEl, scheduledTasks);
            if (tasksInProgressEl) animateCounter(tasksInProgressEl, inProgressTasks);
            if (tasksCompletedEl) animateCounter(tasksCompletedEl, completedTasks);
            
            // Update my tasks page stats
            const myTasksTotalEl = document.getElementById('my-tasks-total');
            const myTasksScheduledEl = document.getElementById('my-tasks-scheduled');
            const myTasksInProgressEl = document.getElementById('my-tasks-inprogress');
            const myTasksCompletedEl = document.getElementById('my-tasks-completed');
            
            if (myTasksTotalEl) animateCounter(myTasksTotalEl, myTotalTasks);
            if (myTasksScheduledEl) animateCounter(myTasksScheduledEl, myScheduledTasks);
            if (myTasksInProgressEl) animateCounter(myTasksInProgressEl, myInProgressTasks);
            if (myTasksCompletedEl) animateCounter(myTasksCompletedEl, myCompletedTasks);
            
            renderDashboardCharts();
            renderDeadlineAlerts();
        }

        function renderRecentTasks() {
            const container = document.getElementById('recent-tasks');
            
            if (tasks.length === 0) {
                container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">No tasks yet. Start by creating your first task!</p>';
                return;
            }
            
            const recentTasks = tasks.slice(0, 5);
            container.innerHTML = recentTasks.map(task => {
                // Get assignee name
                const assigneeName = task.assignee ? (allUsers.find(u => u.email === task.assignee)?.name || task.assignee.split('@')[0]) : null;
                
                // Format due date
                const dueDate = task.dueDate ? new Date(task.dueDate.toDate ? task.dueDate.toDate() : task.dueDate) : null;
                const isOverdue = dueDate && dueDate < new Date() && task.status !== 'completed';
                const dueDateText = dueDate ? dueDate.toLocaleDateString() : null;
                
                // Priority colors
                const priorityColors = {
                    'high': { bg: '#fef2f2', text: '#dc2626', border: '#fecaca' },
                    'medium': { bg: '#fefbf2', text: '#d97706', border: '#fed7aa' },
                    'low': { bg: '#f0fdf4', text: '#16a34a', border: '#bbf7d0' }
                };
                const priority = task.priority || 'medium';
                const priorityColor = priorityColors[priority];
                
                return `
                    <div style="padding: 16px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;" 
                         onmouseover="this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'" 
                         onmouseout="this.style.boxShadow='none'" 
                         onclick="viewTaskDetails('${task.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">${task.title}</div>
                                <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 8px;">${task.description || 'No description'}</div>
                                
                                <!-- Tags Row -->
                                <div style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                                    ${task.projectId ? `<span style="display: flex; align-items: center; gap: 4px; background: #f1f5f9; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; color: #475569;"><div style="width: 6px; height: 6px; border-radius: 50%; background: ${projects.find(p => p.id === task.projectId)?.color || '#3b82f6'};"></div>${projects.find(p => p.id === task.projectId)?.name || 'Unknown'}</span>` : ''}
                                    
                                    <!-- Priority Tag -->
                                    <span style="background: ${priorityColor.bg}; color: ${priorityColor.text}; border: 1px solid ${priorityColor.border}; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase;">
                                        <i class="fas fa-flag" style="margin-right: 4px;"></i>${priority}
                                    </span>
                                    
                                    <!-- Due Date Tag -->
                                    ${dueDateText ? `<span style="background: ${isOverdue ? '#fef2f2' : '#f0f9ff'}; color: ${isOverdue ? '#dc2626' : '#0369a1'}; border: 1px solid ${isOverdue ? '#fecaca' : '#bae6fd'}; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">
                                        <i class="fas fa-calendar" style="margin-right: 4px;"></i>${dueDateText}${isOverdue ? ' (Overdue)' : ''}
                                    </span>` : ''}
                                    
                                    <!-- Assignee Tag -->
                                    ${assigneeName ? `<span style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">
                                        <i class="fas fa-user" style="margin-right: 4px;"></i>${assigneeName}
                                    </span>` : ''}
                                    
                                    <!-- Status Tag -->
                                    <span style="background: ${task.status === 'completed' ? '#dcfce7' : task.status === 'in-progress' ? '#fef3c7' : '#f1f5f9'}; color: ${task.status === 'completed' ? '#166534' : task.status === 'in-progress' ? '#92400e' : '#475569'}; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase;">
                                        ${task.status === 'completed' ? '✓' : task.status === 'in-progress' ? '⏳' : '📋'} ${task.status || 'scheduled'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Navigation functions
        function showView(viewName) {
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Add active class to clicked nav link
            document.querySelector(`[data-view="${viewName}"]`).classList.add('active');
            
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            
            // Show selected view
            document.getElementById(`${viewName}-view`).classList.add('active');
            
            // Load view-specific data
            if (viewName === 'tasks') {
                renderTasksList();
            } else if (viewName === 'my-tasks') {
                renderMyTasksList(currentMyTasksFilter);
            } else if (viewName === 'projects') {
                renderProjectsList();
            } else if (viewName === 'users') {
                renderUsersList();
            } else if (viewName === 'calendar') {
                renderCalendar();
            } else if (viewName === 'analytics') {
                analyticsRendered = false;
                renderAnalytics();
            } else if (viewName === 'kanban') {
                renderKanban();
            }
        }
        
        let currentTaskFilter = 'all';
        let currentMyTasksFilter = 'all';
        
        function renderMyTasksList(filter = 'all') {
            const container = document.getElementById('my-tasks-list');
            currentMyTasksFilter = filter;
            
            // Filter tasks assigned to current user
            let myTasks = tasks.filter(task => task.assignee === currentUser?.email);
            
            if (filter === 'scheduled') {
                myTasks = myTasks.filter(t => t.status === 'scheduled' || t.status === 'pending' || !t.status);
            } else if (filter === 'completed') {
                myTasks = myTasks.filter(t => t.status === 'completed');
            } else if (filter === 'in-progress') {
                myTasks = myTasks.filter(t => t.status === 'in-progress');
            }
            
            if (myTasks.length === 0) {
                const filterText = filter === 'all' ? '' : ` ${filter}`;
                container.innerHTML = `<p style="color: #64748b; text-align: center; padding: 2rem;">No${filterText} tasks assigned to you.</p>`;
                return;
            }
            
            container.innerHTML = myTasks.map(task => {
                // Get assignee name
                const assigneeName = task.assignee ? (allUsers.find(u => u.email === task.assignee)?.name || task.assignee.split('@')[0]) : null;
                
                // Format due date
                const dueDate = task.dueDate ? new Date(task.dueDate.toDate ? task.dueDate.toDate() : task.dueDate) : null;
                const isOverdue = dueDate && dueDate < new Date() && task.status !== 'completed';
                const dueDateText = dueDate ? dueDate.toLocaleDateString() : null;
                
                // Priority colors
                const priorityColors = {
                    'high': { bg: '#fef2f2', text: '#dc2626', border: '#fecaca' },
                    'medium': { bg: '#fefbf2', text: '#d97706', border: '#fed7aa' },
                    'low': { bg: '#f0fdf4', text: '#16a34a', border: '#bbf7d0' }
                };
                const priority = task.priority || 'medium';
                const priorityColor = priorityColors[priority];
                
                return `
                    <div style="padding: 16px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;" 
                         onmouseover="this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'" 
                         onmouseout="this.style.boxShadow='none'" 
                         onclick="viewTaskDetails('${task.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">${task.title}</div>
                                <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 8px;">${task.description || 'No description'}</div>
                                
                                <!-- Tags Row -->
                                <div style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                                    ${task.projectId ? `<span style="display: flex; align-items: center; gap: 4px; background: #f1f5f9; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; color: #475569;"><div style="width: 6px; height: 6px; border-radius: 50%; background: ${projects.find(p => p.id === task.projectId)?.color || '#3b82f6'};"></div>${projects.find(p => p.id === task.projectId)?.name || 'Unknown'}</span>` : ''}
                                    
                                    <!-- Priority Tag -->
                                    <span style="background: ${priorityColor.bg}; color: ${priorityColor.text}; border: 1px solid ${priorityColor.border}; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase;">
                                        <i class="fas fa-flag" style="margin-right: 4px;"></i>${priority}
                                    </span>
                                    
                                    <!-- Due Date Tag -->
                                    ${dueDateText ? `<span style="background: ${isOverdue ? '#fef2f2' : '#f0f9ff'}; color: ${isOverdue ? '#dc2626' : '#0369a1'}; border: 1px solid ${isOverdue ? '#fecaca' : '#bae6fd'}; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">
                                        <i class="fas fa-calendar" style="margin-right: 4px;"></i>${dueDateText}${isOverdue ? ' (Overdue)' : ''}
                                    </span>` : ''}
                                    
                                    <!-- Status Tag -->
                                    <span style="background: ${task.status === 'completed' ? '#dcfce7' : task.status === 'in-progress' ? '#fef3c7' : '#f1f5f9'}; color: ${task.status === 'completed' ? '#166534' : task.status === 'in-progress' ? '#92400e' : '#475569'}; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase;">
                                        ${task.status === 'completed' ? '✓' : task.status === 'in-progress' ? '⏳' : '📋'} ${task.status || 'scheduled'}
                                    </span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; margin-left: 12px;" onclick="event.stopPropagation();">
                                <button onclick="editTask('${task.id}')" style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // My Tasks filter function
        window.showMyTasksByFilter = function(filter) {
            currentMyTasksFilter = filter;
            // Update filter title
            const filterTitle = document.getElementById('my-tasks-filter-title');
            if (filterTitle) {
                const titles = {
                    'all': 'My Tasks',
                    'scheduled': 'My Scheduled Tasks',
                    'in-progress': 'My In Progress Tasks',
                    'completed': 'My Completed Tasks'
                };
                filterTitle.textContent = titles[filter] || 'My Tasks';
            }
            renderMyTasksList(filter);
        }
        
        function renderTasksList(filter = 'all') {
            const container = document.getElementById('tasks-list');
            currentTaskFilter = filter;
            
            let filteredTasks = tasks;
            if (filter === 'scheduled') {
                filteredTasks = tasks.filter(t => t.status === 'scheduled' || t.status === 'pending' || !t.status);
            } else if (filter === 'completed') {
                filteredTasks = tasks.filter(t => t.status === 'completed');
            } else if (filter === 'in-progress') {
                filteredTasks = tasks.filter(t => t.status === 'in-progress');
            } else if (filter === 'overdue') {
                const now = new Date();
                filteredTasks = tasks.filter(t => {
                    if (!t.dueDate || t.status === 'completed') return false;
                    const dueDate = new Date(t.dueDate.toDate ? t.dueDate.toDate() : t.dueDate);
                    return dueDate < now;
                });
            } else if (filter === 'due-today') {
                const now = new Date();
                filteredTasks = tasks.filter(t => {
                    if (!t.dueDate || t.status === 'completed') return false;
                    const dueDate = new Date(t.dueDate.toDate ? t.dueDate.toDate() : t.dueDate);
                    return dueDate.toDateString() === now.toDateString();
                });
            } else if (filter === 'upcoming') {
                const now = new Date();
                filteredTasks = tasks.filter(t => {
                    if (!t.dueDate || t.status === 'completed') return false;
                    const dueDate = new Date(t.dueDate.toDate ? t.dueDate.toDate() : t.dueDate);
                    const daysDiff = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
                    return daysDiff > 0 && daysDiff <= 3;
                });
            }
            
            if (filteredTasks.length === 0) {
                const filterText = filter === 'all' ? '' : ` ${filter}`;
                container.innerHTML = `<p style="color: #64748b; text-align: center; padding: 2rem;">No${filterText} tasks found.</p>`;
                return;
            }
            
            container.innerHTML = filteredTasks.map(task => {
                // Get assignee name
                const assigneeName = task.assignee ? (allUsers.find(u => u.email === task.assignee)?.name || task.assignee.split('@')[0]) : null;
                
                // Format due date
                const dueDate = task.dueDate ? new Date(task.dueDate.toDate ? task.dueDate.toDate() : task.dueDate) : null;
                const isOverdue = dueDate && dueDate < new Date() && task.status !== 'completed';
                const dueDateText = dueDate ? dueDate.toLocaleDateString() : null;
                
                // Priority colors
                const priorityColors = {
                    'high': { bg: '#fef2f2', text: '#dc2626', border: '#fecaca' },
                    'medium': { bg: '#fefbf2', text: '#d97706', border: '#fed7aa' },
                    'low': { bg: '#f0fdf4', text: '#16a34a', border: '#bbf7d0' }
                };
                const priority = task.priority || 'medium';
                const priorityColor = priorityColors[priority];
                
                return `
                    <div style="padding: 16px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;" 
                         onmouseover="this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'" 
                         onmouseout="this.style.boxShadow='none'" 
                         onclick="viewTaskDetails('${task.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">${task.title}</div>
                                <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 8px;">${task.description || 'No description'}</div>
                                
                                <!-- Tags Row -->
                                <div style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                                    ${task.projectId ? `<span style="display: flex; align-items: center; gap: 4px; background: #f1f5f9; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; color: #475569;"><div style="width: 6px; height: 6px; border-radius: 50%; background: ${projects.find(p => p.id === task.projectId)?.color || '#3b82f6'};"></div>${projects.find(p => p.id === task.projectId)?.name || 'Unknown'}</span>` : ''}
                                    
                                    <!-- Priority Tag -->
                                    <span style="background: ${priorityColor.bg}; color: ${priorityColor.text}; border: 1px solid ${priorityColor.border}; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase;">
                                        <i class="fas fa-flag" style="margin-right: 4px;"></i>${priority}
                                    </span>
                                    
                                    <!-- Due Date Tag -->
                                    ${dueDateText ? `<span style="background: ${isOverdue ? '#fef2f2' : '#f0f9ff'}; color: ${isOverdue ? '#dc2626' : '#0369a1'}; border: 1px solid ${isOverdue ? '#fecaca' : '#bae6fd'}; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">
                                        <i class="fas fa-calendar" style="margin-right: 4px;"></i>${dueDateText}${isOverdue ? ' (Overdue)' : ''}
                                    </span>` : ''}
                                    
                                    <!-- Assignee Tag -->
                                    ${assigneeName ? `<span style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">
                                        <i class="fas fa-user" style="margin-right: 4px;"></i>${assigneeName}
                                    </span>` : ''}
                                    
                                    <!-- Status Tag -->
                                    <span style="background: ${task.status === 'completed' ? '#dcfce7' : task.status === 'in-progress' ? '#fef3c7' : '#f1f5f9'}; color: ${task.status === 'completed' ? '#166534' : task.status === 'in-progress' ? '#92400e' : '#475569'}; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase;">
                                        ${task.status === 'completed' ? '✓' : task.status === 'in-progress' ? '⏳' : '📋'} ${task.status || 'scheduled'}
                                    </span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; margin-left: 12px;" onclick="event.stopPropagation();">
                                <button onclick="quickUpdateTask('${task.id}')" style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;" title="Add Quick Comment">
                                    <i class="fas fa-comment"></i>
                                </button>
                                <button onclick="editTask('${task.id}')" style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteTask('${task.id}')" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderProjectsList() {
            const container = document.getElementById('projects-list');
            
            if (projects.length === 0) {
                container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">No projects yet. Create your first project!</p>';
                return;
            }
            
            container.innerHTML = projects.map(project => `
                <div style="padding: 16px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">${project.name}</div>
                        <div style="font-size: 0.875rem; color: #64748b;">${project.description || 'No description'}</div>
                        <div style="font-size: 0.75rem; color: #64748b; margin-top: 8px; display: flex; align-items: center; gap: 8px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: ${project.color || '#3b82f6'};"></div>
                            Tasks: ${tasks.filter(t => t.projectId === project.id).length}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="editProject('${project.id}')" style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteProject('${project.id}')" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Task modal functions
        function openTaskModal(taskId = null) {
            const title = taskId ? 'Edit Task' : 'Add New Task';
            const task = taskId ? tasks.find(t => t.id === taskId) : null;
            
            const modalHtml = `
                <div id="task-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3>${title}</h3>
                            <button onclick="closeTaskModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">&times;</button>
                        </div>
                        <form id="task-form" onsubmit="saveTask(event, '${taskId || ''}')">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Title *</label>
                                <input type="text" id="task-title" required style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;" value="${task?.title || ''}">
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Description</label>
                                <textarea id="task-description" rows="3" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px; resize: vertical;">${task?.description || ''}</textarea>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Project</label>
                                <select id="task-project" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;">
                                    <option value="">No Project</option>
                                    ${projects.map(p => `<option value="${p.id}" ${task?.projectId === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                                </select>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Priority</label>
                                    <select id="task-priority" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;">
                                        <option value="low" ${task?.priority === 'low' ? 'selected' : ''}>Low</option>
                                        <option value="medium" ${task?.priority === 'medium' ? 'selected' : 'selected'}>Medium</option>
                                        <option value="high" ${task?.priority === 'high' ? 'selected' : ''}>High</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Status</label>
                                    <select id="task-status" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;">
                                        <option value="scheduled" ${task?.status === 'scheduled' || task?.status === 'pending' || !task?.status ? 'selected' : ''}>Scheduled</option>
                                        <option value="in-progress" ${task?.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="completed" ${task?.status === 'completed' ? 'selected' : ''}>Completed</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Due Date *</label>
                                    <input type="datetime-local" id="task-due-date" required style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;" value="${task?.dueDate ? new Date(task.dueDate.toDate ? task.dueDate.toDate() : task.dueDate).toISOString().slice(0, 16) : ''}">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Assignee *</label>
                                    <select id="task-assignee" required style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;">
                                        <option value="">Select Assignee</option>
                                        ${allUsers.map(user => `<option value="${user.email}" ${task?.assignee === user.email ? 'selected' : ''}>${user.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Tags</label>
                                <input type="text" id="task-tags" placeholder="Enter tags separated by commas" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;" value="${task?.tags ? task.tags.join(', ') : ''}">
                            </div>
                            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                                <button type="button" onclick="closeTaskModal()" style="padding: 8px 16px; border: 1px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                                <button type="submit" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">Save Task</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Beautiful task details modal
        window.viewTaskDetails = function(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const project = task.projectId ? projects.find(p => p.id === task.projectId) : null;
            const priorityColors = { high: '#ef4444', medium: '#f59e0b', low: '#10b981' };
            const statusColors = { completed: '#10b981', 'in-progress': '#f59e0b', pending: '#64748b' };
            
            const modalHtml = `
                <div id="task-details-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px);">
                    <div style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); padding: 2.5rem; border-radius: 20px; max-width: 700px; width: 95%; max-height: 95vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 1.5rem;">
                            <div>
                                <h1 style="color: #1e293b; margin: 0 0 0.5rem 0; font-size: 1.75rem; font-weight: 700;">${task.title}</h1>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span style="background: ${priorityColors[task.priority] || '#64748b'}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">${task.priority || 'Medium'}</span>
                                    <span style="background: ${statusColors[task.status] || '#64748b'}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">${task.status || 'Pending'}</span>
                                </div>
                            </div>
                            <button onclick="closeTaskDetailsModal()" style="background: #ef4444; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(239,68,68,0.3);">&times;</button>
                        </div>
                        
                        ${project ? `
                            <div style="background: linear-gradient(135deg, ${project.color}15, ${project.color}05); border: 1px solid ${project.color}30; border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 16px; height: 16px; border-radius: 50%; background: ${project.color}; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
                                    <div>
                                        <h4 style="color: #374151; margin: 0; font-size: 0.875rem; font-weight: 600;">PROJECT</h4>
                                        <p style="color: #1e293b; margin: 0; font-weight: 600; font-size: 1.1rem;">${project.name}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${task.description ? `
                            <div style="margin-bottom: 1.5rem;">
                                <h4 style="color: #374151; margin-bottom: 0.75rem; font-weight: 600; display: flex; align-items: center; gap: 8px;"><i class="fas fa-align-left" style="color: #3b82f6;"></i> Description</h4>
                                <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.25rem;">
                                    <p style="color: #4b5563; line-height: 1.7; margin: 0; font-size: 0.95rem;">${task.description}</p>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            ${task.dueDate ? `
                                <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 12px; padding: 1rem;">
                                    <h4 style="color: #92400e; margin: 0 0 0.5rem 0; font-size: 0.875rem; font-weight: 600; display: flex; align-items: center; gap: 8px;"><i class="fas fa-calendar"></i> DUE DATE</h4>
                                    <p style="color: #1e293b; margin: 0; font-weight: 600;">${new Date(task.dueDate.toDate ? task.dueDate.toDate() : task.dueDate).toLocaleDateString()}</p>
                                    <p style="color: #64748b; margin: 0; font-size: 0.875rem;">${new Date(task.dueDate.toDate ? task.dueDate.toDate() : task.dueDate).toLocaleTimeString()}</p>
                                </div>
                            ` : ''}
                            ${task.assignee ? `
                                <div style="background: #dbeafe; border: 1px solid #3b82f6; border-radius: 12px; padding: 1rem;">
                                    <h4 style="color: #1e40af; margin: 0 0 0.5rem 0; font-size: 0.875rem; font-weight: 600; display: flex; align-items: center; gap: 8px;"><i class="fas fa-user"></i> ASSIGNEE</h4>
                                    <p style="color: #1e293b; margin: 0; font-weight: 600;">${task.assignee}</p>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${task.tags && task.tags.length > 0 ? `
                            <div style="margin-bottom: 1.5rem;">
                                <h4 style="color: #374151; margin-bottom: 0.75rem; font-weight: 600; display: flex; align-items: center; gap: 8px;"><i class="fas fa-tags" style="color: #8b5cf6;"></i> Tags</h4>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    ${task.tags.map(tag => `<span style="background: linear-gradient(135deg, #8b5cf6, #a855f7); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; box-shadow: 0 2px 4px rgba(139,92,246,0.3);">#${tag}</span>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem; color: #64748b; border-top: 2px solid #e2e8f0; padding-top: 1.5rem; margin-bottom: 1.5rem;">
                            <div style="text-align: center; padding: 0.75rem; background: #f8fafc; border-radius: 8px;">
                                <i class="fas fa-plus-circle" style="color: #10b981; margin-bottom: 4px;"></i><br>
                                <strong>Created:</strong><br>${task.createdAt ? new Date(task.createdAt.toDate ? task.createdAt.toDate() : task.createdAt).toLocaleDateString() : 'Unknown'}
                            </div>
                            <div style="text-align: center; padding: 0.75rem; background: #f8fafc; border-radius: 8px;">
                                <i class="fas fa-edit" style="color: #3b82f6; margin-bottom: 4px;"></i><br>
                                <strong>Updated:</strong><br>${task.updatedAt ? new Date(task.updatedAt.toDate ? task.updatedAt.toDate() : task.updatedAt).toLocaleDateString() : 'Unknown'}
                            </div>
                        </div>
                        
                        <!-- Comments Section -->
                        <div style="margin-bottom: 2rem;">
                            <h4 style="color: #374151; margin-bottom: 1rem; font-weight: 600; display: flex; align-items: center; gap: 8px;"><i class="fas fa-comments" style="color: #10b981;"></i> Comments</h4>
                            
                            <!-- Add Comment Form -->
                            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                                <textarea id="comment-input-${task.id}" placeholder="Add a comment..." style="width: 100%; min-height: 80px; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; resize: vertical; font-family: inherit; font-size: 0.875rem;"></textarea>
                                <div style="display: flex; justify-content: flex-end; margin-top: 0.75rem;">
                                    <button onclick="addComment('${task.id}')" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500;">
                                        <i class="fas fa-paper-plane"></i> Add Comment
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Comments List -->
                            <div id="comments-list-${task.id}" style="max-height: 300px; overflow-y: auto;">
                                <div style="text-align: center; color: #9ca3af; padding: 1rem;">Loading comments...</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button onclick="quickUpdateTask('${task.id}');" style="padding: 12px 24px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 6px rgba(16,185,129,0.3); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(16,185,129,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(16,185,129,0.3)';">
                                <i class="fas fa-comment"></i> Quick Comment
                            </button>
                            <button onclick="editTask('${task.id}'); closeTaskDetailsModal();" style="padding: 12px 24px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 6px rgba(59,130,246,0.3); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(59,130,246,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(59,130,246,0.3)';">
                                <i class="fas fa-edit"></i> Edit Task
                            </button>
                            <button onclick="closeTaskDetailsModal()" style="padding: 12px 24px; border: 2px solid #e2e8f0; background: white; border-radius: 25px; cursor: pointer; font-weight: 600; color: #64748b; transition: all 0.2s;" onmouseover="this.style.borderColor='#3b82f6'; this.style.color='#3b82f6';" onmouseout="this.style.borderColor='#e2e8f0'; this.style.color='#64748b';">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Load comments for this task
            loadTaskComments(task.id);
        }

        window.closeTaskDetailsModal = function() {
            const modal = document.getElementById('task-details-modal');
            if (modal) modal.remove();
        }

        // Bulk import modal
        window.openBulkImportModal = function() {
            const modalHtml = `
                <div id="bulk-import-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3>Import Tasks from CSV</h3>
                            <button onclick="closeBulkImportModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">&times;</button>
                        </div>
                        
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin-bottom: 0.5rem; color: #374151;">CSV Format:</h4>
                            <p style="font-size: 0.875rem; color: #64748b; margin-bottom: 0.5rem;">Your CSV should have these columns:</p>
                            <code style="background: white; padding: 0.5rem; border-radius: 4px; display: block; font-size: 0.75rem;">Task,Details,Owner,Status,Start date,End date,email</code>
                            <p style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem;">Example: "Fix login bug","Resolve authentication issue","John Doe","pending","2024-12-20","2024-12-25","john@email.com"</p>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Select CSV File</label>
                            <input type="file" id="csv-file" accept=".csv" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;">
                        </div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button onclick="closeBulkImportModal()" style="padding: 8px 16px; border: 1px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                            <button onclick="processBulkImport()" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">Import Tasks</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        window.closeBulkImportModal = function() {
            const modal = document.getElementById('bulk-import-modal');
            if (modal) modal.remove();
        }

        window.processBulkImport = async function() {
            const fileInput = document.getElementById('csv-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file');
                return;
            }
            
            try {
                const text = await file.text();
                const lines = text.split('\n').filter(line => line.trim());
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                
                const tasks = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    const task = {};
                    
                    headers.forEach((header, index) => {
                        if (values[index]) {
                            switch(header.toLowerCase().trim()) {
                                case 'task':
                                    task.title = values[index];
                                    break;
                                case 'details':
                                    task.description = values[index];
                                    break;
                                case 'owner':
                                    task.owner = values[index];
                                    break;
                                case 'status':
                                    // Map your status values to our system
                                    const statusMap = {
                                        'pending': 'pending',
                                        'in progress': 'in-progress',
                                        'in-progress': 'in-progress',
                                        'done': 'completed',
                                        'completed': 'completed',
                                        'complete': 'completed'
                                    };
                                    task.status = statusMap[values[index].toLowerCase()] || 'pending';
                                    break;
                                case 'start date':
                                    task.startDate = values[index] ? new Date(values[index]) : null;
                                    break;
                                case 'end date':
                                    task.dueDate = values[index] ? new Date(values[index]) : null;
                                    break;
                                case 'email':
                                    task.assignee = values[index];
                                    break;
                            }
                        }
                    });
                    
                    // Set default priority if not provided
                    if (!task.priority) {
                        task.priority = 'medium';
                    }
                    
                    if (task.title) {
                        task.userId = currentUser.uid;
                        task.createdAt = new Date();
                        task.updatedAt = new Date();
                        tasks.push(task);
                    }
                }
                
                // Import tasks to Firestore
                let imported = 0;
                for (const task of tasks) {
                    try {
                        await db.collection('tasks').add(task);
                        imported++;
                    } catch (error) {
                        console.error('Error importing task:', task.title, error);
                    }
                }
                
                closeBulkImportModal();
                await loadTasks();
                updateStats();
                renderTasksList();
                renderRecentTasks();
                
                showNotification(`Successfully imported ${imported} out of ${tasks.length} tasks!`, 'success');
                
            } catch (error) {
                console.error('Error processing CSV:', error);
                alert('Error processing CSV file. Please check the format.');
            }
        }

        function openProjectModal(projectId = null) {
            const title = projectId ? 'Edit Project' : 'Add New Project';
            const project = projectId ? projects.find(p => p.id === projectId) : null;
            
            const modalHtml = `
                <div id="project-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3>${title}</h3>
                            <button onclick="closeProjectModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">&times;</button>
                        </div>
                        <form id="project-form" onsubmit="saveProject(event, '${projectId || ''}')">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Project Name *</label>
                                <input type="text" id="project-name" required style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;" value="${project?.name || ''}">
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Description</label>
                                <textarea id="project-description" rows="3" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px; resize: vertical;">${project?.description || ''}</textarea>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Color</label>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    ${['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#06b6d4', '#f97316', '#84cc16'].map(color => `
                                        <div onclick="selectProjectColor('${color}')" 
                                             style="width: 40px; height: 40px; background: ${color}; border-radius: 8px; cursor: pointer; border: 3px solid ${project?.color === color ? '#1e293b' : 'transparent'}; transition: all 0.2s;" 
                                             data-color="${color}"></div>
                                    `).join('')}
                                </div>
                                <input type="hidden" id="project-color" value="${project?.color || '#3b82f6'}">
                            </div>
                            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                                <button type="button" onclick="closeProjectModal()" style="padding: 8px 16px; border: 1px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                                <button type="submit" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">Save Project</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        window.closeTaskModal = function() {
            const modal = document.getElementById('task-modal');
            if (modal) modal.remove();
        }
        
        window.saveTask = async function(event, taskId) {
            event.preventDefault();
            
            // Validate required fields
            const title = document.getElementById('task-title').value.trim();
            const dueDate = document.getElementById('task-due-date').value;
            const assignee = document.getElementById('task-assignee').value;
            
            if (!title) {
                alert('Title is required');
                return;
            }
            if (!dueDate) {
                alert('Due Date is required');
                return;
            }
            if (!assignee) {
                alert('Assignee is required');
                return;
            }
            
            const taskData = {
                title: title,
                description: document.getElementById('task-description').value,
                projectId: document.getElementById('task-project').value || null,
                priority: document.getElementById('task-priority').value,
                status: document.getElementById('task-status').value,
                dueDate: new Date(dueDate),
                assignee: assignee,
                tags: document.getElementById('task-tags').value ? document.getElementById('task-tags').value.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                userId: currentUser.uid,
                updatedAt: new Date()
            };
            
            try {
                if (taskId) {
                    const oldTask = tasks.find(t => t.id === taskId);
                    await db.collection('tasks').doc(taskId).update(taskData);
                    
                    const assigneeName = taskData.assignee ? (allUsers.find(u => u.email === taskData.assignee)?.name || taskData.assignee.split('@')[0]) : null;
                    const updaterName = currentUser.displayName || currentUser.email.split('@')[0];
                    
                    // Show local notification
                    const message = assigneeName && taskData.assignee !== currentUser.email ? 
                        `Task "${taskData.title}" assigned to ${assigneeName}` : 
                        `Task "${taskData.title}" updated successfully`;
                    showNotification(message, 'success');
                    
                    // Send notifications to other users
                    if (taskData.assignee && taskData.assignee !== currentUser.email) {
                        // Notify the assignee
                        await sendNotificationToUser(taskData.assignee, 
                            `Task "${taskData.title}" has been ${oldTask?.assignee === taskData.assignee ? 'updated' : 'assigned to you'} by ${updaterName}`, 
                            'info');
                    }
                    
                    // Notify old assignee if changed
                    if (oldTask?.assignee && oldTask.assignee !== taskData.assignee && oldTask.assignee !== currentUser.email) {
                        await sendNotificationToUser(oldTask.assignee, 
                            `Task "${taskData.title}" has been reassigned by ${updaterName}`, 
                            'warning');
                    }
                    
                    // Broadcast status changes to all users
                    if (oldTask?.status !== taskData.status) {
                        await broadcastNotification(
                            `Task "${taskData.title}" status changed to ${taskData.status.replace('-', ' ')} by ${updaterName}`, 
                            'info'
                        );
                    }
                } else {
                    taskData.createdAt = new Date();
                    await db.collection('tasks').add(taskData);
                    
                    const assigneeName = taskData.assignee ? (allUsers.find(u => u.email === taskData.assignee)?.name || taskData.assignee.split('@')[0]) : null;
                    const creatorName = currentUser.displayName || currentUser.email.split('@')[0];
                    
                    // Show local notification
                    const message = assigneeName && taskData.assignee !== currentUser.email ? 
                        `New task "${taskData.title}" assigned to ${assigneeName}` : 
                        `Task "${taskData.title}" created successfully`;
                    showNotification(message, 'success');
                    
                    // Send notification to assignee if different from creator
                    if (taskData.assignee && taskData.assignee !== currentUser.email) {
                        await sendNotificationToUser(taskData.assignee, 
                            `New task "${taskData.title}" has been assigned to you by ${creatorName}`, 
                            'info');
                    }
                    
                    // Broadcast new task creation to all users
                    await broadcastNotification(
                        `New task "${taskData.title}" created by ${creatorName}`, 
                        'info'
                    );
                }
                
                closeTaskModal();
                await loadTasks();
                updateStats();
                renderTasksList();
                renderRecentTasks();
            } catch (error) {
                console.error('Error saving task:', error);
                alert('Error saving task');
            }
        }
        
        window.editTask = function(taskId) {
            openTaskModal(taskId);
        }
        
        window.quickUpdateTask = async function(taskId) {
            try {
                const task = tasks.find(t => t.id === taskId);
                const requesterName = currentUser.displayName || currentUser.email.split('@')[0];
                
                await db.collection('comments').add({
                    taskId: taskId,
                    text: 'Please share your latest update and let us know if you are facing any challenges or hurdles.',
                    authorEmail: currentUser.email,
                    authorName: requesterName,
                    userId: currentUser.uid,
                    createdAt: new Date(),
                    updatedAt: new Date()
                });
                
                // Refresh comments if modal is open
                const commentsContainer = document.getElementById(`comments-list-${taskId}`);
                if (commentsContainer) {
                    await loadTaskComments(taskId);
                }
                
                showNotification(`Update requested for "${task?.title || 'task'}"`, 'info');
                
                // Notify task assignee if different from requester
                if (task?.assignee && task.assignee !== currentUser.email) {
                    await sendNotificationToUser(task.assignee, 
                        `${requesterName} requested an update on your task "${task.title}"`, 
                        'warning');
                }
            } catch (error) {
                console.error('Error adding comment:', error);
                alert('Error adding comment');
            }
        }
        
        window.deleteTask = async function(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) return;
            
            try {
                const task = tasks.find(t => t.id === taskId);
                const taskTitle = task?.title || 'Task';
                const deleterName = currentUser.displayName || currentUser.email.split('@')[0];
                
                await db.collection('tasks').doc(taskId).delete();
                await loadTasks();
                updateStats();
                renderTasksList();
                renderRecentTasks();
                showNotification(`"${taskTitle}" deleted successfully`, 'success');
                
                // Notify assignee if different from deleter
                if (task?.assignee && task.assignee !== currentUser.email) {
                    await sendNotificationToUser(task.assignee, 
                        `Task "${taskTitle}" assigned to you has been deleted by ${deleterName}`, 
                        'warning');
                }
                
                // Broadcast task deletion to all users
                await broadcastNotification(
                    `Task "${taskTitle}" has been deleted by ${deleterName}`, 
                    'warning'
                );
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('Error deleting task');
            }
        }
        
        window.editProject = function(projectId) {
            openProjectModal(projectId);
        }
        
        window.closeProjectModal = function() {
            const modal = document.getElementById('project-modal');
            if (modal) modal.remove();
        }
        
        window.selectProjectColor = function(color) {
            document.getElementById('project-color').value = color;
            document.querySelectorAll('[data-color]').forEach(el => {
                el.style.border = el.dataset.color === color ? '3px solid #1e293b' : '3px solid transparent';
            });
        }
        
        window.saveProject = async function(event, projectId) {
            event.preventDefault();
            
            const projectData = {
                name: document.getElementById('project-name').value,
                description: document.getElementById('project-description').value,
                color: document.getElementById('project-color').value,
                userId: currentUser.uid,
                updatedAt: new Date()
            };
            
            try {
                if (projectId) {
                    await db.collection('projects').doc(projectId).update(projectData);
                    showNotification(`Project "${projectData.name}" updated successfully`, 'success');
                    
                    // Broadcast project update to all users
                    const updaterName = currentUser.displayName || currentUser.email.split('@')[0];
                    await broadcastNotification(
                        `Project "${projectData.name}" has been updated by ${updaterName}`, 
                        'info'
                    );
                } else {
                    projectData.createdAt = new Date();
                    await db.collection('projects').add(projectData);
                    showNotification(`Project "${projectData.name}" created successfully`, 'success');
                    
                    // Broadcast new project creation to all users
                    const creatorName = currentUser.displayName || currentUser.email.split('@')[0];
                    await broadcastNotification(
                        `New project "${projectData.name}" has been created by ${creatorName}`, 
                        'info'
                    );
                }
                
                closeProjectModal();
                await loadProjects();
                renderProjectsList();
                renderTasksList();
            } catch (error) {
                console.error('Error saving project:', error);
                alert('Error saving project');
            }
        }
        
        window.deleteProject = async function(projectId) {
            if (!confirm('Are you sure you want to delete this project?')) return;
            
            try {
                const project = projects.find(p => p.id === projectId);
                const projectName = project?.name || 'Project';
                const deleterName = currentUser.displayName || currentUser.email.split('@')[0];
                
                await db.collection('projects').doc(projectId).delete();
                await loadProjects();
                renderProjectsList();
                showNotification(`"${projectName}" project deleted successfully`, 'success');
                
                // Broadcast project deletion to all users
                await broadcastNotification(
                    `Project "${projectName}" has been deleted by ${deleterName}`, 
                    'warning'
                );
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('Error deleting project');
            }
        }
        
        // Load available users
        async function loadUsers() {
            try {
                const userEmails = new Set();
                
                // Add current user
                if (currentUser) {
                    userEmails.add(currentUser.email);
                }
                
                // Add users from current user's tasks
                tasks.forEach(task => {
                    if (task.assignee) userEmails.add(task.assignee);
                    if (task.owner) userEmails.add(task.owner);
                });
                
                // Add users from current user's projects
                projects.forEach(project => {
                    if (project.owner) userEmails.add(project.owner);
                });
                
                // Add all users from database if available
                if (allUsers && allUsers.length > 0) {
                    allUsers.forEach(user => {
                        if (user.email) userEmails.add(user.email);
                    });
                }
                
                // Convert to user objects
                availableUsers = Array.from(userEmails).map(email => {
                    if (email === currentUser?.email) {
                        return {
                            email: email,
                            name: currentUser.displayName || currentUser.email.split('@')[0]
                        };
                    }
                    return {
                        email: email,
                        name: email.split('@')[0]
                    };
                });
                
                console.log('Loaded users:', availableUsers.length);
            } catch (error) {
                console.error('Error loading users:', error);
                // Fallback to just current user
                availableUsers = currentUser ? [{
                    email: currentUser.email,
                    name: currentUser.displayName || currentUser.email.split('@')[0]
                }] : [];
            }
        }
        
        function getAvailableUsers() {
            return availableUsers;
        }
        
        // Load current user data from Firestore
        async function loadCurrentUserData() {
            try {
                if (!currentUser) return;
                
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    currentUserData = { id: userDoc.id, ...userDoc.data() };
                } else {
                    // Create user document if doesn't exist
                    currentUserData = {
                        name: currentUser.displayName || currentUser.email.split('@')[0],
                        email: currentUser.email,
                        role: 'Member',
                        designation: 'Team Member',
                        createdAt: new Date(),
                        updatedAt: new Date()
                    };
                    await db.collection('users').doc(currentUser.uid).set(currentUserData);
                }
                console.log('Current user data:', currentUserData);
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }
        
        // Update welcome message with user role
        function updateWelcomeMessage() {
            const welcomeMsg = document.getElementById('welcome-message');
            if (welcomeMsg && currentUserData) {
                const userName = currentUserData.name || currentUser.displayName || currentUser.email.split('@')[0];
                const userRole = currentUserData.role || 'Member';
                welcomeMsg.textContent = `Welcome back, ${userName}! (${userRole}) Here's your task overview.`;
            }
        }
        
        // Load all users
        async function loadAllUsers() {
            try {
                const snapshot = await db.collection('users').get();
                allUsers = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                console.log('Loaded all users:', allUsers.length);
            } catch (error) {
                console.error('Error loading all users:', error);
            }
        }
        
        // Initialize predefined users
        window.initializeUsers = async function() {
            if (currentUserData?.role !== 'Admin') {
                alert('Only admins can initialize users');
                return;
            }
            
            const predefinedUsers = [
                { name: 'Syed Asad Ahmed Rizvi', designation: 'Head - IT Network & Security', role: 'Admin', email: 'rizvi.asad@jsbl.com' },
                { name: 'Syed Kumail Abbas', designation: 'Senior Manager - Network Projects & Implementation', role: 'Manager', email: 'a.kumail@jsbl.com' },
                { name: 'Syed Muhammad Murtaza', designation: 'Senior Manager - Networks Business Integrations', role: 'Manager', email: 'muhammad.murtaza@jsbl.com' },
                { name: 'Musaddiq Hasan', designation: 'Senior Manager - Network Vendor Management & Service Delivery', role: 'Admin', email: 'musaddiq.hasan@jsbl.com' },
                { name: 'Arsalan Afridi', designation: 'Manager – Network Alliances & Operations', role: 'Manager', email: 'arsalan.afridi@jsbl.com' },
                { name: 'Ahmer Afaq', designation: 'Deputy Manager – Network Integration Projects', role: 'Manager', email: 'ahmer.afaq@jsbl.com' },
                { name: 'Shahroz Ahmed Siddiqui', designation: 'Network Projects Lead', role: 'Manager', email: 'shahroz.siddiqui@jsbl.com' },
                { name: 'Mudassir Azam', designation: 'Network Engineer', role: 'Member', email: 'mudassir.azam@jsbl.com' },
                { name: 'Talha Mazhar', designation: 'Network Operations Support Specialist', role: 'Member', email: 'commtel.talham@jsbl.com' },
                { name: 'Abdul Samad Khan', designation: 'Network Operations Support Specialist', role: 'Member', email: 'commtel.abdulsamad@jsbl.com' },
                { name: 'Muhammad Usama Khan', designation: 'Network Operations Support Specialist', role: 'Member', email: 'commtel.usama@jsbl.com' },
                { name: 'Ghazala Sajjad', designation: 'Network Operations & Compliance Officer', role: 'Member', email: 'arcana.ghazala@jsbl.com' },
                { name: 'Hamna', designation: 'Team Lead - Network Operations Center', role: 'Member', email: 'commtel.hammna@jsbl.com' }
            ];
            
            try {
                let created = 0;
                for (const user of predefinedUsers) {
                    // Check if user already exists
                    const existingUser = await db.collection('users').where('email', '==', user.email).get();
                    
                    if (existingUser.empty) {
                        await db.collection('users').add({
                            ...user,
                            createdAt: new Date(),
                            updatedAt: new Date()
                        });
                        created++;
                    }
                }
                
                await loadAllUsers();
                renderUsersList();
                showNotification(`Initialized ${created} new users!`, 'success');
            } catch (error) {
                console.error('Error initializing users:', error);
                alert('Error initializing users');
            }
        }
        
        // Render users list
        function renderUsersList() {
            if (currentUserData?.role !== 'Admin') return;
            
            const container = document.getElementById('users-list');
            
            if (allUsers.length === 0) {
                container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">No users found. Click "Initialize Users" to add team members.</p>';
                return;
            }
            
            container.innerHTML = allUsers.map(user => {
                // Count pending tasks assigned to this user
                const pendingTasks = tasks.filter(task => 
                    task.assignee === user.email && 
                    task.status !== 'completed'
                ).length;
                
                return `
                    <div style="padding: 16px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div style="font-weight: 600; color: #1e293b;">${user.name}</div>
                                ${pendingTasks > 0 ? `<span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">${pendingTasks} pending</span>` : ''}
                            </div>
                            <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 4px;">${user.designation}</div>
                            <div style="font-size: 0.75rem; color: #64748b; display: flex; align-items: center; gap: 12px;">
                                <span>Email: ${user.email}</span>
                                <span style="padding: 2px 8px; border-radius: 12px; background: ${user.role === 'Admin' ? '#fef3c7' : user.role === 'Manager' ? '#dbeafe' : '#f1f5f9'}; color: ${user.role === 'Admin' ? '#92400e' : user.role === 'Manager' ? '#1e40af' : '#475569'};">${user.role}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="editUser('${user.id}')" style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteUser('${user.id}')" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // User modal functions
        window.openUserModal = function(userId = null) {
            if (currentUserData?.role !== 'Admin') {
                alert('Only admins can manage users');
                return;
            }
            
            const title = userId ? 'Edit User' : 'Add New User';
            const user = userId ? allUsers.find(u => u.id === userId) : null;
            
            const modalHtml = `
                <div id="user-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3>${title}</h3>
                            <button onclick="closeUserModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">&times;</button>
                        </div>
                        <form id="user-form" onsubmit="saveUser(event, '${userId || ''}')">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Name *</label>
                                <input type="text" id="user-name" name="name" required style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; background: white; color: #1f2937;" value="${user?.name || ''}" placeholder="Enter full name">
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Email *</label>
                                <input type="email" id="user-email" name="email" required style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; background: white; color: #1f2937;" value="${user?.email || ''}" placeholder="Enter email address">
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Designation</label>
                                <input type="text" id="user-designation" name="designation" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;" value="${user?.designation || ''}">
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Role</label>
                                <select id="user-role" name="role" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;">
                                    <option value="Member" ${user?.role === 'Member' ? 'selected' : ''}>Member</option>
                                    <option value="Manager" ${user?.role === 'Manager' ? 'selected' : ''}>Manager</option>
                                    <option value="Admin" ${user?.role === 'Admin' ? 'selected' : ''}>Admin</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                                <button type="button" onclick="closeUserModal()" style="padding: 8px 16px; border: 1px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                                <button type="submit" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">Save User</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        window.closeUserModal = function() {
            const modal = document.getElementById('user-modal');
            if (modal) modal.remove();
        }
        
        window.saveUser = async function(event, userId) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            const name = formData.get('name')?.trim() || document.getElementById('user-name')?.value?.trim() || '';
            const email = formData.get('email')?.trim() || document.getElementById('user-email')?.value?.trim() || '';
            const designation = formData.get('designation')?.trim() || document.getElementById('user-designation')?.value?.trim() || '';
            const role = formData.get('role') || document.getElementById('user-role')?.value || 'Member';
            
            console.log('Form values:', { name, email, designation, role });
            
            if (!name) {
                alert('Name is required');
                document.getElementById('user-name')?.focus();
                return;
            }
            
            if (!email) {
                alert('Email is required');
                document.getElementById('user-email')?.focus();
                return;
            }
            
            const userData = {
                name: name,
                email: email,
                designation: designation,
                role: role,
                updatedAt: new Date()
            };
            
            console.log('User data to save:', userData);
            
            try {
                if (userId) {
                    await db.collection('users').doc(userId).update(userData);
                    showNotification('User updated successfully!', 'success');
                    
                    // Notify the updated user if it's not the current user
                    if (userData.email !== currentUser.email) {
                        await sendNotificationToUser(userData.email, 
                            `Your profile has been updated by ${currentUser.displayName || currentUser.email.split('@')[0]}`, 
                            'info');
                    }
                } else {
                    userData.createdAt = new Date();
                    const newUserRef = await db.collection('users').add(userData);
                    showNotification('User created successfully!', 'success');
                    
                    // Broadcast new user addition to all users
                    await broadcastNotification(
                        `New team member ${userData.name} has been added to the system`, 
                        'info'
                    );
                }
                
                closeUserModal();
                await loadAllUsers();
                renderUsersList();
            } catch (error) {
                console.error('Error saving user:', error);
                alert('Error saving user: ' + (error.message || error));
            }
        }
        
        window.editUser = function(userId) {
            openUserModal(userId);
        }
        
        window.deleteUser = async function(userId) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            
            try {
                const userToDelete = allUsers.find(u => u.id === userId);
                const deleterName = currentUser.displayName || currentUser.email.split('@')[0];
                
                await db.collection('users').doc(userId).delete();
                await loadAllUsers();
                renderUsersList();
                showNotification('User deleted successfully!', 'success');
                
                // Broadcast user deletion to all users
                if (userToDelete) {
                    await broadcastNotification(
                        `Team member ${userToDelete.name} has been removed from the system by ${deleterName}`, 
                        'warning'
                    );
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Error deleting user');
            }
        }
        
        // Calendar functionality
        let currentCalendarView = 'year';
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        
        function renderCalendar() {
            const container = document.getElementById('calendar-container');
            if (!container) return;
            
            if (currentCalendarView === 'year') {
                renderYearView(container);
            } else {
                renderMonthView(container);
            }
        }
        
        function renderYearView(container) {
            const tasksWithDates = tasks.filter(task => task.dueDate);
            const tasksByMonth = {};
            
            // Group tasks by month
            tasksWithDates.forEach(task => {
                const date = new Date(task.dueDate.toDate ? task.dueDate.toDate() : task.dueDate);
                if (date.getFullYear() === currentYear) {
                    const monthKey = date.getMonth();
                    if (!tasksByMonth[monthKey]) tasksByMonth[monthKey] = [];
                    tasksByMonth[monthKey].push(task);
                }
            });
            
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                    <button onclick="changeYear(-1)" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
                        <i class="fas fa-chevron-left"></i> <span class="year-btn-text">${currentYear - 1}</span>
                    </button>
                    <h2 style="color: #1e293b; margin: 0; font-size: clamp(1.5rem, 4vw, 2rem);">${currentYear}</h2>
                    <button onclick="changeYear(1)" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
                        <span class="year-btn-text">${currentYear + 1}</span> <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <style>
                    @media (max-width: 480px) {
                        .year-btn-text { display: none; }
                    }
                </style>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;" class="year-grid">
                    ${months.map((month, index) => {
                        const taskCount = tasksByMonth[index] ? tasksByMonth[index].length : 0;
                        const completedCount = tasksByMonth[index] ? tasksByMonth[index].filter(t => t.status === 'completed').length : 0;
                        return `
                            <div onclick="showMonth(${index})" style="
                                background: white; 
                                border: 2px solid ${taskCount > 0 ? '#3b82f6' : '#e2e8f0'}; 
                                border-radius: 12px; 
                                padding: 1.5rem; 
                                cursor: pointer; 
                                transition: all 0.2s;
                                text-align: center;
                                ${taskCount > 0 ? 'box-shadow: 0 4px 6px rgba(59, 130, 246, 0.1);' : ''}
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 15px rgba(0,0,0,0.1)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='${taskCount > 0 ? '0 4px 6px rgba(59, 130, 246, 0.1)' : 'none'}';}">
                                <h3 style="color: #1e293b; margin-bottom: 1rem; font-size: 1.25rem;">${month}</h3>
                                ${taskCount > 0 ? `
                                    <div style="display: flex; justify-content: space-around; margin-bottom: 1rem;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 2rem; font-weight: bold; color: #3b82f6;">${taskCount}</div>
                                            <div style="font-size: 0.875rem; color: #64748b;">Total Tasks</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 2rem; font-weight: bold; color: #10b981;">${completedCount}</div>
                                            <div style="font-size: 0.875rem; color: #64748b;">Completed</div>
                                        </div>
                                    </div>
                                    <div style="width: 100%; background: #e2e8f0; border-radius: 10px; height: 8px; overflow: hidden;">
                                        <div style="width: ${taskCount > 0 ? (completedCount / taskCount) * 100 : 0}%; background: linear-gradient(90deg, #10b981, #059669); height: 100%; border-radius: 10px; transition: width 0.3s;"></div>
                                    </div>
                                ` : `
                                    <div style="color: #94a3b8; font-size: 0.875rem;">No tasks this month</div>
                                `}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function renderMonthView(container) {
            const tasksWithDates = tasks.filter(task => task.dueDate);
            const monthTasks = tasksWithDates.filter(task => {
                const date = new Date(task.dueDate.toDate ? task.dueDate.toDate() : task.dueDate);
                return date.getFullYear() === currentYear && date.getMonth() === currentMonth;
            });
            
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            // Group tasks by date
            const tasksByDate = {};
            monthTasks.forEach(task => {
                const date = new Date(task.dueDate.toDate ? task.dueDate.toDate() : task.dueDate);
                const dateKey = date.getDate();
                if (!tasksByDate[dateKey]) tasksByDate[dateKey] = [];
                tasksByDate[dateKey].push(task);
            });
            
            // Generate calendar grid
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            let calendarHTML = '';
            let dayCount = 1;
            
            // Create exactly 6 weeks (42 days) grid to ensure complete calendar
            for (let week = 0; week < 6; week++) {
                calendarHTML += '<div>';
                
                for (let day = 0; day < 7; day++) {
                    if (week === 0 && day < firstDay) {
                        // Empty cells before month starts
                        calendarHTML += '<div style="background: #f8fafc;"></div>';
                    } else if (dayCount <= daysInMonth) {
                        // Days of current month
                        const dayTasks = tasksByDate[dayCount] || [];
                        const isToday = new Date().toDateString() === new Date(currentYear, currentMonth, dayCount).toDateString();
                        
                        calendarHTML += `
                            <div style="
                                background: ${isToday ? '#eff6ff' : 'white'}; 
                                padding: 4px;
                                position: relative;
                                ${isToday ? 'border: 2px solid #3b82f6;' : ''}
                            ">
                                <div style="font-weight: ${isToday ? 'bold' : 'normal'}; color: ${isToday ? '#3b82f6' : '#1e293b'}; margin-bottom: 2px;">${dayCount}</div>
                                ${dayTasks.slice(0, 1).map(task => `
                                    <div onclick="viewTaskDetails('${task.id}')" style="
                                        background: ${task.priority === 'high' ? '#fef2f2' : task.priority === 'medium' ? '#fefbf2' : '#f0fdf4'};
                                        border-left: 2px solid ${task.priority === 'high' ? '#ef4444' : task.priority === 'medium' ? '#f59e0b' : '#10b981'};
                                        padding: 1px 2px;
                                        margin-bottom: 1px;
                                        font-size: 0.65rem;
                                        cursor: pointer;
                                        border-radius: 2px;
                                        line-height: 1.1;
                                    ">
                                        ${task.title.length > 8 ? task.title.substring(0, 8) + '...' : task.title}
                                    </div>
                                `).join('')}
                                ${dayTasks.length > 1 ? `<div style="font-size: 0.6rem; color: #64748b; text-align: center;">+${dayTasks.length - 1}</div>` : ''}
                            </div>
                        `;
                        dayCount++;
                    } else {
                        // Empty cells after month ends
                        calendarHTML += '<div style="background: #f8fafc;"></div>';
                    }
                }
                
                calendarHTML += '</div>';
            }
            
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
                    <button onclick="showYear()" style="background: #64748b; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
                        <i class="fas fa-arrow-left"></i> <span class="back-text">Back</span>
                    </button>
                    <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1; justify-content: center;">
                        <button onclick="changeMonth(-1)" style="background: #3b82f6; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <h2 style="color: #1e293b; margin: 0; text-align: center; font-size: clamp(1.2rem, 4vw, 1.5rem); white-space: nowrap;">${monthNames[currentMonth]} ${currentYear}</h2>
                        <button onclick="changeMonth(1)" style="background: #3b82f6; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div style="width: 60px;"></div>
                </div>
                <style>
                    @media (max-width: 480px) {
                        .back-text { display: none; }
                    }
                </style>
                
                <div class="calendar-header">
                    ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => `
                        <div>${day}</div>
                    `).join('')}
                </div>
                
                <div class="calendar-grid">
                    ${calendarHTML}
                </div>
            `;
        }
        
        window.changeYear = function(direction) {
            currentYear += direction;
            renderCalendar();
        }
        
        window.showMonth = function(monthIndex) {
            currentMonth = monthIndex;
            currentCalendarView = 'month';
            renderCalendar();
        }
        
        window.showYear = function() {
            currentCalendarView = 'year';
            renderCalendar();
        }
        
        window.changeMonth = function(direction) {
            currentMonth += direction;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }
        
        // Analytics functionality
        let analyticsCharts = {};
        let analyticsRendered = false;
        
        function renderAnalytics() {
            if (analyticsRendered) return;
            analyticsRendered = true;
            
            setTimeout(() => {
                updateAnalyticsMetrics();
                renderStatusChart();
                renderPriorityChart();
                renderTimelineChart();
                renderProjectProgress();
                renderInsights();
            }, 100);
        }
        
        function updateAnalyticsMetrics() {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.status === 'completed').length;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            // Calculate average completion time
            const completedWithDates = tasks.filter(t => t.status === 'completed' && t.createdAt && t.updatedAt);
            let avgDays = 0;
            if (completedWithDates.length > 0) {
                const totalDays = completedWithDates.reduce((sum, task) => {
                    const created = new Date(task.createdAt.toDate ? task.createdAt.toDate() : task.createdAt);
                    const updated = new Date(task.updatedAt.toDate ? task.updatedAt.toDate() : task.updatedAt);
                    return sum + Math.ceil((updated - created) / (1000 * 60 * 60 * 24));
                }, 0);
                avgDays = Math.round(totalDays / completedWithDates.length);
            }
            
            // Calculate overdue tasks
            const now = new Date();
            const overdueTasks = tasks.filter(t => {
                if (!t.dueDate || t.status === 'completed') return false;
                const dueDate = new Date(t.dueDate.toDate ? t.dueDate.toDate() : t.dueDate);
                return dueDate < now;
            }).length;
            
            // Calculate productivity score (0-100)
            const productivityScore = Math.round(
                (completionRate * 0.4) + 
                (Math.max(0, 100 - (overdueTasks * 10)) * 0.3) + 
                (Math.max(0, 100 - (avgDays * 5)) * 0.3)
            );
            
            document.getElementById('completion-rate').textContent = `${completionRate}%`;
            document.getElementById('avg-completion-time').textContent = `${avgDays}d`;
            document.getElementById('overdue-tasks').textContent = overdueTasks;
            document.getElementById('productivity-score').textContent = productivityScore;
        }
        
        function renderStatusChart() {
            const ctx = document.getElementById('status-chart');
            if (!ctx) return;
            
            if (analyticsCharts.status) {
                analyticsCharts.status.destroy();
            }
            
            const statusCounts = {
                'pending': tasks.filter(t => t.status === 'pending' || !t.status).length,
                'in-progress': tasks.filter(t => t.status === 'in-progress').length,
                'completed': tasks.filter(t => t.status === 'completed').length
            };
            
            analyticsCharts.status = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pending', 'In Progress', 'Completed'],
                    datasets: [{
                        data: [statusCounts.pending, statusCounts['in-progress'], statusCounts.completed],
                        backgroundColor: ['#f59e0b', '#3b82f6', '#10b981'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 10
                            }
                        }
                    }
                }
            });
        }
        
        function renderPriorityChart() {
            const ctx = document.getElementById('priority-chart');
            if (!ctx) return;
            
            if (analyticsCharts.priority) {
                analyticsCharts.priority.destroy();
            }
            
            const priorityCounts = {
                'high': tasks.filter(t => t.priority === 'high').length,
                'medium': tasks.filter(t => t.priority === 'medium' || !t.priority).length,
                'low': tasks.filter(t => t.priority === 'low').length
            };
            
            analyticsCharts.priority = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['High', 'Medium', 'Low'],
                    datasets: [{
                        data: [priorityCounts.high, priorityCounts.medium, priorityCounts.low],
                        backgroundColor: ['#ef4444', '#f59e0b', '#10b981'],
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        function renderTimelineChart() {
            const ctx = document.getElementById('timeline-chart');
            if (!ctx) return;
            
            if (analyticsCharts.timeline) {
                analyticsCharts.timeline.destroy();
            }
            
            // Get last 7 days
            const last7Days = [];
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                last7Days.push(date);
            }
            
            const completionData = last7Days.map(date => {
                return tasks.filter(task => {
                    if (task.status !== 'completed' || !task.updatedAt) return false;
                    const taskDate = new Date(task.updatedAt.toDate ? task.updatedAt.toDate() : task.updatedAt);
                    return taskDate.toDateString() === date.toDateString();
                }).length;
            });
            
            analyticsCharts.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days.map(date => date.toLocaleDateString('en-US', { weekday: 'short' })),
                    datasets: [{
                        data: completionData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        function renderProjectProgress() {
            const container = document.getElementById('project-progress');
            if (!container) return;
            
            if (projects.length === 0) {
                container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">No projects yet</p>';
                return;
            }
            
            const projectStats = projects.map(project => {
                const projectTasks = tasks.filter(t => t.projectId === project.id);
                const completedTasks = projectTasks.filter(t => t.status === 'completed').length;
                const totalTasks = projectTasks.length;
                const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                
                return {
                    ...project,
                    totalTasks,
                    completedTasks,
                    progress
                };
            });
            
            container.innerHTML = projectStats.map(project => `
                <div style="margin-bottom: 1rem; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: ${project.color};"></div>
                            <span style="font-weight: 600; color: #1e293b;">${project.name}</span>
                        </div>
                        <span style="font-size: 0.875rem; color: #64748b;">${project.completedTasks}/${project.totalTasks}</span>
                    </div>
                    <div style="width: 100%; background: #e2e8f0; border-radius: 10px; height: 8px; overflow: hidden;">
                        <div style="width: ${project.progress}%; background: ${project.color}; height: 100%; border-radius: 10px; transition: width 0.3s;"></div>
                    </div>
                    <div style="text-align: right; margin-top: 0.25rem; font-size: 0.75rem; color: #64748b;">${project.progress}%</div>
                </div>
            `).join('');
        }
        
        function renderInsights() {
            const container = document.getElementById('insights-list');
            if (!container) return;
            
            const insights = [];
            
            // Most productive day
            const dayStats = {};
            tasks.filter(t => t.status === 'completed' && t.updatedAt).forEach(task => {
                const day = new Date(task.updatedAt.toDate ? task.updatedAt.toDate() : task.updatedAt).toLocaleDateString('en-US', { weekday: 'long' });
                dayStats[day] = (dayStats[day] || 0) + 1;
            });
            const mostProductiveDay = Object.keys(dayStats).reduce((a, b) => dayStats[a] > dayStats[b] ? a : b, 'Monday');
            if (Object.keys(dayStats).length > 0) {
                insights.push({
                    icon: 'fas fa-calendar-check',
                    color: '#10b981',
                    title: 'Most Productive Day',
                    description: `You complete most tasks on ${mostProductiveDay}s`
                });
            }
            
            // Overdue warning
            const overdueTasks = tasks.filter(t => {
                if (!t.dueDate || t.status === 'completed') return false;
                const dueDate = new Date(t.dueDate.toDate ? t.dueDate.toDate() : t.dueDate);
                return dueDate < new Date();
            }).length;
            
            if (overdueTasks > 0) {
                insights.push({
                    icon: 'fas fa-exclamation-triangle',
                    color: '#ef4444',
                    title: 'Overdue Tasks',
                    description: `You have ${overdueTasks} overdue task${overdueTasks > 1 ? 's' : ''} that need attention`
                });
            }
            
            // High priority focus
            const highPriorityPending = tasks.filter(t => t.priority === 'high' && t.status !== 'completed').length;
            if (highPriorityPending > 0) {
                insights.push({
                    icon: 'fas fa-fire',
                    color: '#f59e0b',
                    title: 'High Priority Focus',
                    description: `${highPriorityPending} high-priority task${highPriorityPending > 1 ? 's' : ''} pending completion`
                });
            }
            
            // Completion streak
            const recentCompletions = tasks.filter(t => {
                if (t.status !== 'completed' || !t.updatedAt) return false;
                const taskDate = new Date(t.updatedAt.toDate ? t.updatedAt.toDate() : t.updatedAt);
                const daysDiff = Math.ceil((new Date() - taskDate) / (1000 * 60 * 60 * 24));
                return daysDiff <= 7;
            }).length;
            
            if (recentCompletions > 0) {
                insights.push({
                    icon: 'fas fa-trophy',
                    color: '#8b5cf6',
                    title: 'Great Progress',
                    description: `You've completed ${recentCompletions} task${recentCompletions > 1 ? 's' : ''} this week!`
                });
            }
            
            if (insights.length === 0) {
                container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">Complete some tasks to see insights!</p>';
                return;
            }
            
            container.innerHTML = insights.map(insight => `
                <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="width: 48px; height: 48px; border-radius: 50%; background: ${insight.color}15; display: flex; align-items: center; justify-content: center;">
                        <i class="${insight.icon}" style="color: ${insight.color}; font-size: 1.25rem;"></i>
                    </div>
                    <div>
                        <div style="font-weight: 600; color: #1e293b; margin-bottom: 0.25rem;">${insight.title}</div>
                        <div style="color: #64748b; font-size: 0.875rem;">${insight.description}</div>
                    </div>
                </div>
            `).join('');
        }
        
        // Dashboard card click handlers
        window.showTasksByFilter = function(filter) {
            currentTaskFilter = filter;
            showView('tasks');
            // Update filter title
            const filterTitle = document.getElementById('tasks-filter-title');
            if (filterTitle) {
                const titles = {
                    'all': 'All Tasks',
                    'scheduled': 'Scheduled Tasks',
                    'in-progress': 'In Progress Tasks',
                    'completed': 'Completed Tasks',
                    'overdue': 'Overdue Tasks',
                    'due-today': 'Due Today',
                    'upcoming': 'Upcoming Deadlines'
                };
                filterTitle.textContent = titles[filter] || 'All Tasks';
            }
            // Force re-render with filter
            setTimeout(() => {
                renderTasksList(filter);
            }, 100);
        }
        
        // Dashboard charts
        let dashboardCharts = {};
        
        function renderDashboardCharts() {
            renderDashboardStatusChart();
            renderDashboardOverdueChart();
            renderDashboardPriorityChart();
        }
        
        function renderDashboardStatusChart() {
            const ctx = document.getElementById('dashboard-status-chart');
            if (!ctx) return;
            
            if (dashboardCharts.status) {
                dashboardCharts.status.destroy();
            }
            
            const statusCounts = {
                'scheduled': tasks.filter(t => t.status === 'scheduled' || t.status === 'pending' || !t.status).length,
                'in-progress': tasks.filter(t => t.status === 'in-progress').length,
                'completed': tasks.filter(t => t.status === 'completed').length
            };
            
            dashboardCharts.status = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Scheduled', 'In Progress', 'Completed'],
                    datasets: [{
                        data: [statusCounts.scheduled, statusCounts['in-progress'], statusCounts.completed],
                        backgroundColor: ['#f093fb', '#fbbf24', '#4facfe'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 10,
                                padding: 8,
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        }
        
        function renderDashboardOverdueChart() {
            const ctx = document.getElementById('dashboard-overdue-chart');
            if (!ctx) return;
            
            if (dashboardCharts.overdue) {
                dashboardCharts.overdue.destroy();
            }
            
            const now = new Date();
            const overdueTasks = tasks.filter(t => {
                if (!t.dueDate || t.status === 'completed') return false;
                const dueDate = new Date(t.dueDate.toDate ? t.dueDate.toDate() : t.dueDate);
                return dueDate < now;
            }).length;
            
            const onTimeTasks = tasks.filter(t => t.status !== 'completed').length - overdueTasks;
            
            dashboardCharts.overdue = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['On Time', 'Overdue'],
                    datasets: [{
                        data: [onTimeTasks, overdueTasks],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        function renderDashboardPriorityChart() {
            const ctx = document.getElementById('dashboard-priority-chart');
            if (!ctx) return;
            
            if (dashboardCharts.priority) {
                dashboardCharts.priority.destroy();
            }
            
            const priorityCounts = {
                'high': tasks.filter(t => t.priority === 'high').length,
                'medium': tasks.filter(t => t.priority === 'medium' || !t.priority).length,
                'low': tasks.filter(t => t.priority === 'low').length
            };
            
            dashboardCharts.priority = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['High', 'Medium', 'Low'],
                    datasets: [{
                        data: [priorityCounts.high, priorityCounts.medium, priorityCounts.low],
                        backgroundColor: ['#ef4444', '#f59e0b', '#10b981'],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        function renderDeadlineAlerts() {
            const container = document.getElementById('deadline-alerts');
            if (!container) return;
            
            const now = new Date();
            const alerts = [];
            
            // Overdue tasks
            const overdueTasks = tasks.filter(t => {
                if (!t.dueDate || t.status === 'completed') return false;
                const dueDate = new Date(t.dueDate.toDate ? t.dueDate.toDate() : t.dueDate);
                return dueDate < now;
            });
            
            // Due today
            const dueTodayTasks = tasks.filter(t => {
                if (!t.dueDate || t.status === 'completed') return false;
                const dueDate = new Date(t.dueDate.toDate ? t.dueDate.toDate() : t.dueDate);
                return dueDate.toDateString() === now.toDateString();
            });
            
            // Due within 3 days
            const upcomingTasks = tasks.filter(t => {
                if (!t.dueDate || t.status === 'completed') return false;
                const dueDate = new Date(t.dueDate.toDate ? t.dueDate.toDate() : t.dueDate);
                const daysDiff = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
                return daysDiff > 0 && daysDiff <= 3;
            });
            
            if (overdueTasks.length > 0) {
                alerts.push({
                    type: 'error',
                    icon: 'fas fa-exclamation-triangle',
                    title: `${overdueTasks.length} Overdue Task${overdueTasks.length > 1 ? 's' : ''}`,
                    message: `You have ${overdueTasks.length} task${overdueTasks.length > 1 ? 's' : ''} past their deadline`,
                    filter: 'overdue'
                });
            }
            
            if (dueTodayTasks.length > 0) {
                alerts.push({
                    type: 'warning',
                    icon: 'fas fa-clock',
                    title: `${dueTodayTasks.length} Task${dueTodayTasks.length > 1 ? 's' : ''} Due Today`,
                    message: `Complete these tasks before end of day`,
                    filter: 'due-today'
                });
            }
            
            if (upcomingTasks.length > 0) {
                alerts.push({
                    type: 'info',
                    icon: 'fas fa-calendar-alt',
                    title: `${upcomingTasks.length} Upcoming Deadline${upcomingTasks.length > 1 ? 's' : ''}`,
                    message: `Tasks due within the next 3 days`,
                    filter: 'upcoming'
                });
            }
            
            if (alerts.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = alerts.map(alert => `
                <div class="alert alert-${alert.type}" onclick="showTasksByFilter('${alert.filter}')" style="
                    background: ${alert.type === 'error' ? '#fef2f2' : alert.type === 'warning' ? '#fefbf2' : '#eff6ff'};
                    border: 1px solid ${alert.type === 'error' ? '#fecaca' : alert.type === 'warning' ? '#fed7aa' : '#bfdbfe'};
                    border-radius: 8px;
                    padding: 1rem;
                    margin-bottom: 1rem;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                    transition: all 0.2s;
                " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        background: ${alert.type === 'error' ? '#ef4444' : alert.type === 'warning' ? '#f59e0b' : '#3b82f6'};
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                    ">
                        <i class="${alert.icon}"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #1e293b; margin-bottom: 0.25rem;">${alert.title}</div>
                        <div style="color: #64748b; font-size: 0.875rem;">${alert.message}</div>
                    </div>
                    <i class="fas fa-chevron-right" style="color: #9ca3af;"></i>
                </div>
            `).join('');
        }
        
        // Kanban functionality
        function renderKanban() {
            const columns = {
                'scheduled': document.querySelector('[data-status="scheduled"] .kanban-tasks'),
                'in-progress': document.querySelector('[data-status="in-progress"] .kanban-tasks'),
                'completed': document.querySelector('[data-status="completed"] .kanban-tasks')
            };
            
            // Clear columns
            Object.values(columns).forEach(column => {
                if (column) column.innerHTML = '';
            });
            
            // Group tasks by status
            const tasksByStatus = {
                'scheduled': tasks.filter(t => t.status === 'scheduled' || t.status === 'pending' || !t.status),
                'in-progress': tasks.filter(t => t.status === 'in-progress'),
                'completed': tasks.filter(t => t.status === 'completed')
            };
            
            // Update task counts
            Object.keys(tasksByStatus).forEach(status => {
                const count = tasksByStatus[status].length;
                const countEl = document.querySelector(`[data-status="${status}"] .task-count`);
                if (countEl) countEl.textContent = count;
            });
            
            // Render tasks in columns
            Object.keys(tasksByStatus).forEach(status => {
                const column = columns[status];
                if (!column) return;
                
                tasksByStatus[status].forEach(task => {
                    const taskCard = createKanbanTaskCard(task);
                    column.appendChild(taskCard);
                });
                
                // Add drop zone styling
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('drop', handleDrop);
            });
        }
        
        function createKanbanTaskCard(task) {
            const card = document.createElement('div');
            card.className = 'kanban-task';
            card.draggable = true;
            card.dataset.taskId = task.id;
            
            const assigneeName = task.assignee ? (allUsers.find(u => u.email === task.assignee)?.name || task.assignee.split('@')[0]) : null;
            const dueDate = task.dueDate ? new Date(task.dueDate.toDate ? task.dueDate.toDate() : task.dueDate) : null;
            const isOverdue = dueDate && dueDate < new Date() && task.status !== 'completed';
            const dueDateText = dueDate ? dueDate.toLocaleDateString() : null;
            
            const priorityColors = {
                'high': '#ef4444',
                'medium': '#f59e0b',
                'low': '#10b981'
            };
            
            card.style.cssText = `
                background: white;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                padding: 12px;
                margin-bottom: 8px;
                cursor: grab;
                transition: all 0.2s;
                border-left: 4px solid ${priorityColors[task.priority] || '#64748b'};
            `;
            
            card.innerHTML = `
                <div style="font-weight: 600; color: #1e293b; margin-bottom: 6px; font-size: 0.875rem;">${task.title}</div>
                <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 8px; line-height: 1.3;">${task.description || 'No description'}</div>
                <div style="display: flex; flex-wrap: wrap; gap: 4px; align-items: center;">
                    <span style="background: ${priorityColors[task.priority] || '#64748b'}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.65rem; font-weight: 600; text-transform: uppercase;">
                        ${task.priority || 'medium'}
                    </span>
                    ${dueDateText ? `<span style="background: ${isOverdue ? '#fef2f2' : '#f0f9ff'}; color: ${isOverdue ? '#dc2626' : '#0369a1'}; padding: 2px 6px; border-radius: 10px; font-size: 0.65rem; font-weight: 500;">
                        📅 ${dueDateText}
                    </span>` : ''}
                    ${assigneeName ? `<span style="background: #f3f4f6; color: #374151; padding: 2px 6px; border-radius: 10px; font-size: 0.65rem; font-weight: 500;">
                        👤 ${assigneeName}
                    </span>` : ''}
                </div>
            `;
            
            // Add drag event listeners
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
            card.addEventListener('click', () => viewTaskDetails(task.id));
            
            return card;
        }
        
        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
            e.target.style.opacity = '0.5';
        }
        
        function handleDragEnd(e) {
            e.target.style.opacity = '1';
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.style.background = '#f8fafc';
        }
        
        async function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.style.background = '';
            
            const taskId = e.dataTransfer.getData('text/plain');
            const newStatus = e.currentTarget.closest('.kanban-column').dataset.status;
            
            try {
                const task = tasks.find(t => t.id === taskId);
                const updaterName = currentUser.displayName || currentUser.email.split('@')[0];
                
                await db.collection('tasks').doc(taskId).update({
                    status: newStatus,
                    updatedAt: new Date()
                });
                
                await loadTasks();
                renderKanban();
                updateStats();
                showNotification(`"${task?.title || 'Task'}" moved to ${newStatus.replace('-', ' ')}`, 'success');
                
                // Notify assignee if different from updater
                if (task?.assignee && task.assignee !== currentUser.email) {
                    await sendNotificationToUser(task.assignee, 
                        `Your task "${task.title}" status changed to ${newStatus.replace('-', ' ')} by ${updaterName}`, 
                        'info');
                }
                
                // Broadcast status change to all users
                await broadcastNotification(
                    `Task "${task?.title || 'Task'}" moved to ${newStatus.replace('-', ' ')} by ${updaterName}`, 
                    'info'
                );
            } catch (error) {
                console.error('Error updating task status:', error);
                alert('Error moving task');
            }
        }
        
        // Comments functionality
        async function loadTaskComments(taskId) {
            try {
                const snapshot = await db.collection('comments')
                    .where('taskId', '==', taskId)
                    .get();
                
                const comments = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                })).sort((a, b) => {
                    const dateA = a.createdAt ? new Date(a.createdAt.toDate ? a.createdAt.toDate() : a.createdAt) : new Date(0);
                    const dateB = b.createdAt ? new Date(b.createdAt.toDate ? b.createdAt.toDate() : b.createdAt) : new Date(0);
                    return dateB - dateA; // Sort descending (newest first)
                });
                
                renderComments(taskId, comments);
            } catch (error) {
                console.error('Error loading comments:', error);
                const container = document.getElementById(`comments-list-${taskId}`);
                if (container) {
                    container.innerHTML = '<div style="text-align: center; color: #ef4444; padding: 1rem;">Error loading comments</div>';
                }
            }
        }
        
        function renderComments(taskId, comments) {
            const container = document.getElementById(`comments-list-${taskId}`);
            if (!container) return;
            
            if (comments.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 1rem;">No comments yet. Be the first to comment!</div>';
                return;
            }
            
            container.innerHTML = comments.map(comment => {
                const author = allUsers.find(u => u.email === comment.authorEmail) || { name: comment.authorEmail?.split('@')[0] || 'Unknown' };
                const createdAt = comment.createdAt ? new Date(comment.createdAt.toDate ? comment.createdAt.toDate() : comment.createdAt) : new Date();
                
                return `
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 32px; height: 32px; border-radius: 50%; background: #3b82f6; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.75rem;">
                                    ${author.name?.charAt(0)?.toUpperCase() || '?'}
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: #1f2937; font-size: 0.875rem;">${author.name || 'Unknown User'}</div>
                                    <div style="color: #6b7280; font-size: 0.75rem;">${createdAt.toLocaleString()}</div>
                                </div>
                            </div>
                            ${comment.authorEmail === currentUser?.email ? `
                                <button onclick="deleteComment('${comment.id}', '${taskId}')" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 4px;" title="Delete comment">
                                    <i class="fas fa-trash" style="font-size: 0.75rem;"></i>
                                </button>
                            ` : ''}
                        </div>
                        <div style="color: #374151; line-height: 1.5; font-size: 0.875rem; white-space: pre-wrap;">${comment.text}</div>
                    </div>
                `;
            }).join('');
        }
        
        window.addComment = async function(taskId) {
            const input = document.getElementById(`comment-input-${taskId}`);
            const text = input.value.trim();
            
            if (!text) {
                alert('Please enter a comment');
                return;
            }
            
            try {
                const task = tasks.find(t => t.id === taskId);
                const commenterName = currentUser.displayName || currentUser.email.split('@')[0];
                
                await db.collection('comments').add({
                    taskId: taskId,
                    text: text,
                    authorEmail: currentUser.email,
                    authorName: commenterName,
                    userId: currentUser.uid,
                    createdAt: new Date(),
                    updatedAt: new Date()
                });
                
                input.value = '';
                await loadTaskComments(taskId);
                showNotification('Comment added successfully!', 'success');
                
                // Notify task assignee if different from commenter
                if (task?.assignee && task.assignee !== currentUser.email) {
                    await sendNotificationToUser(task.assignee, 
                        `${commenterName} commented on your task "${task.title}"`, 
                        'info');
                }
                
                // Notify all users who have commented on this task
                const commentsSnapshot = await db.collection('comments').where('taskId', '==', taskId).get();
                const commenters = new Set();
                commentsSnapshot.docs.forEach(doc => {
                    const comment = doc.data();
                    if (comment.authorEmail && comment.authorEmail !== currentUser.email) {
                        commenters.add(comment.authorEmail);
                    }
                });
                
                // Send notifications to other commenters
                for (const commenterEmail of commenters) {
                    if (commenterEmail !== task?.assignee) { // Don't duplicate notification for assignee
                        await sendNotificationToUser(commenterEmail, 
                            `${commenterName} also commented on task "${task?.title || 'Unknown'}"`, 
                            'info');
                    }
                }
            } catch (error) {
                console.error('Error adding comment:', error);
                alert('Error adding comment');
            }
        }
        
        window.deleteComment = async function(commentId, taskId) {
            if (!confirm('Are you sure you want to delete this comment?')) return;
            
            try {
                await db.collection('comments').doc(commentId).delete();
                await loadTaskComments(taskId);
                showNotification('Comment deleted successfully!', 'success');
            } catch (error) {
                console.error('Error deleting comment:', error);
                alert('Error deleting comment');
            }
        }
        
        // Notification system with Firestore sync
        let notificationHistory = [];
        let notificationListener = null;
        
        async function requestNotificationPermission() {
            if ('serviceWorker' in navigator) {
                try {
                    await navigator.serviceWorker.register('/sw.js');
                } catch (error) {
                    console.error('Service Worker registration failed:', error);
                }
            }
            
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }
            return false;
        }
        
        // Setup Firestore notification listener
        function setupNotificationListener() {
            if (!currentUser || notificationListener) return;
            
            console.log('Setting up notification listener for user:', currentUser.uid);
            let lastCheckTime = new Date();
            
            notificationListener = db.collection('notifications')
                .where('userId', '==', currentUser.uid)

                .onSnapshot(snapshot => {
                    console.log('Notification snapshot received:', snapshot.docs.length, 'notifications');
                    
                    const newNotifications = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        timestamp: doc.data().createdAt?.toDate()?.toISOString() || new Date().toISOString()
                    })).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 50);
                    
                    // Check for truly new notifications (not in current history)
                    const existingIds = notificationHistory.map(n => n.id);
                    const newNotifs = newNotifications.filter(notif => 
                        !existingIds.includes(notif.id) && !notif.read
                    );
                    
                    console.log('New notifications found:', newNotifs.length);
                    
                    // Show toast for new notifications
                    newNotifs.forEach(notif => {
                        console.log('Showing notification:', notif.message);
                        showToastNotification(notif.message, notif.type);
                        showBrowserNotification('TaskManager', notif.message, notif.type);
                    });
                    
                    // Update notification history and badge
                    notificationHistory = newNotifications;
                    updateNotificationBadge();
                    
                    // Refresh notification center if open
                    const center = document.getElementById('notification-center');
                    if (center && center.style.display === 'block') {
                        renderNotifications();
                    }
                }, error => {
                    console.error('Notification listener error:', error);
                });
                
            // Check for notifications when app gains focus
            window.addEventListener('focus', () => {
                setTimeout(() => {
                    const unreadNotifs = notificationHistory.filter(n => !n.read && new Date(n.timestamp) > new Date(Date.now() - 300000)); // Last 5 minutes
                    unreadNotifs.forEach(notif => {
                        showToastNotification(notif.message, notif.type);
                    });
                }, 500);
            });
        }
        
        // Sync notifications across tabs/windows
        window.addEventListener('storage', (e) => {
            if (e.key === 'taskflow_notification_sync') {
                updateNotificationBadge();
                const center = document.getElementById('notification-center');
                if (center && center.style.display === 'block') {
                    renderNotifications();
                }
            }
        });
        
        // Show browser notification
        function showBrowserNotification(title, message, type = 'info') {
            if ('Notification' in window && Notification.permission === 'granted') {
                const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️';
                
                // Try service worker notification first (works when app is closed)
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'BACKGROUND_NOTIFICATION',
                        title: `${icon} ${title}`,
                        body: message
                    });
                } else {
                    // Fallback to regular notification
                    new Notification(`${icon} ${title}`, {
                        body: message,
                        icon: '/favicon.ico',
                        badge: '/favicon.ico',
                        tag: 'taskmanager-notification',
                        requireInteraction: false,
                        silent: false
                    });
                }
            }
        }
        
        // Add notification to Firestore for sync
        function showNotification(message, type = 'info') {
            if (!currentUser) return;
            
            // Check for duplicate notifications in the last 5 seconds
            const recentDuplicate = notificationHistory.find(n => 
                n.message === message && 
                n.type === type && 
                new Date() - new Date(n.timestamp) < 5000
            );
            
            if (recentDuplicate) {
                console.log('Duplicate notification prevented:', message);
                return;
            }
            
            db.collection('notifications').add({
                userId: currentUser.uid,
                message: message,
                type: type,
                read: false,
                createdAt: new Date()
            }).catch(error => {
                console.error('Error adding notification:', error);
                // Fallback to local notification
                showToastNotification(message, type);
            });
        }
        
        // Send notification to specific user by email
        async function sendNotificationToUser(userEmail, message, type = 'info') {
            if (!userEmail) return;
            
            try {
                // Find the user's Firebase Auth UID by email
                const userSnapshot = await db.collection('users').where('email', '==', userEmail).get();
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    const userData = userDoc.data();
                    
                    // Use the document ID as the userId (which should be the Firebase Auth UID)
                    await db.collection('notifications').add({
                        userId: userDoc.id,
                        message: message,
                        type: type,
                        read: false,
                        createdAt: new Date()
                    });
                    console.log('Notification sent to user:', userEmail, 'with UID:', userDoc.id);
                } else {
                    console.warn('User not found for email:', userEmail);
                }
            } catch (error) {
                console.error('Error sending notification to user:', error);
            }
        }
        
        // Send notification to all users except current user
        async function broadcastNotification(message, type = 'info', excludeCurrentUser = true) {
            try {
                const usersSnapshot = await db.collection('users').get();
                const batch = db.batch();
                
                usersSnapshot.docs.forEach(userDoc => {
                    const userData = userDoc.data();
                    // Skip current user if excludeCurrentUser is true
                    if (excludeCurrentUser && userData.email === currentUser?.email) {
                        return;
                    }
                    
                    const notificationRef = db.collection('notifications').doc();
                    batch.set(notificationRef, {
                        userId: userDoc.id, // This is the Firebase Auth UID
                        message: message,
                        type: type,
                        read: false,
                        createdAt: new Date()
                    });
                });
                
                console.log('Broadcasting notification to', usersSnapshot.docs.length - (excludeCurrentUser ? 1 : 0), 'users');
                await batch.commit();
            } catch (error) {
                console.error('Error broadcasting notification:', error);
            }
        }
        
        // Show toast notification
        function showToastNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            if (!container) return;
            
            const notification = document.createElement('div');
            const id = 'notif-' + Date.now();
            
            notification.className = `notification ${type}`;
            notification.id = `notification-${id}`;
            
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            notification.innerHTML = `
                <i class="notification-icon ${icons[type] || icons.info}"></i>
                <div class="notification-content">
                    <div class="notification-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close" onclick="removeNotification('${id}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => removeNotification(id), 5000);
        }
        
        function removeNotification(id) {
            const notification = document.getElementById(`notification-${id}`);
            if (notification) {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }
        }
        
        function updateNotificationBadge() {
            const mobileBadge = document.getElementById('notification-badge');
            const desktopBadge = document.getElementById('desktop-notification-badge');
            const unreadCount = notificationHistory.filter(n => !n.read).length;
            
            [mobileBadge, desktopBadge].forEach(badge => {
                if (badge) {
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                        badge.style.display = 'block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            });
            
            // Sync across tabs/windows
            try {
                localStorage.setItem('taskflow_notification_sync', Date.now().toString());
            } catch (e) {
                console.warn('Could not sync notifications across tabs:', e);
            }
        }
        
        window.toggleNotificationCenter = function() {
            console.log('Toggle notification center called');
            const center = document.getElementById('notification-center');
            console.log('Notification center element:', center);
            console.log('Current display:', center?.style.display);
            
            if (center) {
                if (center.style.display === 'none' || !center.style.display) {
                    center.style.display = 'block';
                    renderNotifications();
                    console.log('Notification center opened');
                } else {
                    center.style.display = 'none';
                    console.log('Notification center closed');
                }
            } else {
                console.error('Notification center element not found');
            }
        }
        
        // Add notification button event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const mobileBtn = document.getElementById('notification-btn');
            const desktopBtn = document.getElementById('desktop-notification-btn');
            
            if (mobileBtn) {
                mobileBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Mobile notification button clicked');
                    toggleNotificationCenter();
                });
                console.log('Mobile notification button listener added');
            }
            
            if (desktopBtn) {
                desktopBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Desktop notification button clicked');
                    toggleNotificationCenter();
                });
                console.log('Desktop notification button listener added');
            }
        });
        
        // Close notification center when clicking outside
        document.addEventListener('click', function(e) {
            const center = document.getElementById('notification-center');
            const mobileBtn = document.getElementById('notification-btn');
            const desktopBtn = document.getElementById('desktop-notification-btn');
            
            if (center && center.style.display === 'block' && 
                !center.contains(e.target) && 
                !mobileBtn?.contains(e.target) && 
                !desktopBtn?.contains(e.target)) {
                center.style.display = 'none';
                console.log('Notification center closed by outside click');
            }
        });
        
        function renderNotifications() {
            const container = document.getElementById('notifications-list');
            if (!container) return;
            
            if (notificationHistory.length === 0) {
                container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem; margin: 0;">No notifications yet.</p>';
                return;
            }
            
            container.innerHTML = notificationHistory.map(notif => {
                const date = new Date(notif.timestamp);
                const timeAgo = getTimeAgo(date);
                const icons = {
                    success: 'fas fa-check-circle',
                    error: 'fas fa-exclamation-circle',
                    warning: 'fas fa-exclamation-triangle',
                    info: 'fas fa-info-circle'
                };
                
                return `
                    <div style="padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px; ${!notif.read ? 'background: #f8fafc; border-left: 4px solid #3b82f6;' : ''}">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="${icons[notif.type]}" style="color: ${notif.type === 'success' ? '#10b981' : notif.type === 'error' ? '#ef4444' : notif.type === 'warning' ? '#f59e0b' : '#3b82f6'}; font-size: 1.1rem;"></i>
                            <div style="flex: 1;">
                                <div style="font-weight: ${!notif.read ? '600' : '400'}; color: #1e293b; margin-bottom: 2px;">${notif.message}</div>
                                <div style="color: #64748b; font-size: 0.75rem;">${timeAgo}</div>
                            </div>
                            <button onclick="deleteNotification('${notif.id}')" style="background: none; border: none; color: #9ca3af; cursor: pointer; padding: 4px;" title="Delete">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Mark as read in Firestore
            const unread = notificationHistory.filter(n => !n.read);
            if (unread.length > 0) {
                const batch = db.batch();
                unread.forEach(notif => {
                    batch.update(db.collection('notifications').doc(notif.id), { read: true });
                });
                batch.commit();
            }
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }
        
        window.clearAllNotifications = async function() {
            if (!confirm('Are you sure you want to clear all notifications?')) return;
            
            try {
                const batch = db.batch();
                notificationHistory.forEach(notif => {
                    batch.delete(db.collection('notifications').doc(notif.id));
                });
                await batch.commit();
                // Immediately update local state
                notificationHistory = [];
                updateNotificationBadge();
                renderNotifications();
            } catch (error) {
                console.error('Error clearing notifications:', error);
            }
        }
        
        window.deleteNotification = async function(id) {
            try {
                await db.collection('notifications').doc(id).delete();
                // Immediately update local state
                notificationHistory = notificationHistory.filter(n => n.id !== id);
                updateNotificationBadge();
                renderNotifications();
            } catch (error) {
                console.error('Error deleting notification:', error);
            }
        }
        

        
        // My Tasks functionality
        let currentMyTaskFilter = 'all';
        
        function renderMyTasksList(filter = 'all') {
            const container = document.getElementById('my-tasks-list');
            currentMyTaskFilter = filter;
            
            // Filter tasks assigned to current user
            let myTasks = tasks.filter(task => task.assignee === currentUser?.email);
            
            if (filter === 'scheduled') {
                myTasks = myTasks.filter(t => t.status === 'scheduled' || t.status === 'pending' || !t.status);
            } else if (filter === 'completed') {
                myTasks = myTasks.filter(t => t.status === 'completed');
            } else if (filter === 'in-progress') {
                myTasks = myTasks.filter(t => t.status === 'in-progress');
            }
            
            if (myTasks.length === 0) {
                const filterText = filter === 'all' ? '' : ` ${filter}`;
                container.innerHTML = `<p style="color: #64748b; text-align: center; padding: 2rem;">No${filterText} tasks assigned to you.</p>`;
                return;
            }
            
            container.innerHTML = myTasks.map(task => {
                // Format due date
                const dueDate = task.dueDate ? new Date(task.dueDate.toDate ? task.dueDate.toDate() : task.dueDate) : null;
                const isOverdue = dueDate && dueDate < new Date() && task.status !== 'completed';
                const dueDateText = dueDate ? dueDate.toLocaleDateString() : null;
                
                // Priority colors
                const priorityColors = {
                    'high': { bg: '#fef2f2', text: '#dc2626', border: '#fecaca' },
                    'medium': { bg: '#fefbf2', text: '#d97706', border: '#fed7aa' },
                    'low': { bg: '#f0fdf4', text: '#16a34a', border: '#bbf7d0' }
                };
                const priority = task.priority || 'medium';
                const priorityColor = priorityColors[priority];
                
                return `
                    <div style="padding: 16px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;" 
                         onmouseover="this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'" 
                         onmouseout="this.style.boxShadow='none'" 
                         onclick="viewTaskDetails('${task.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">${task.title}</div>
                                <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 8px;">${task.description || 'No description'}</div>
                                
                                <!-- Tags Row -->
                                <div style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                                    ${task.projectId ? `<span style="display: flex; align-items: center; gap: 4px; background: #f1f5f9; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; color: #475569;"><div style="width: 6px; height: 6px; border-radius: 50%; background: ${projects.find(p => p.id === task.projectId)?.color || '#3b82f6'};"></div>${projects.find(p => p.id === task.projectId)?.name || 'Unknown'}</span>` : ''}
                                    
                                    <!-- Priority Tag -->
                                    <span style="background: ${priorityColor.bg}; color: ${priorityColor.text}; border: 1px solid ${priorityColor.border}; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase;">
                                        <i class="fas fa-flag" style="margin-right: 4px;"></i>${priority}
                                    </span>
                                    
                                    <!-- Due Date Tag -->
                                    ${dueDateText ? `<span style="background: ${isOverdue ? '#fef2f2' : '#f0f9ff'}; color: ${isOverdue ? '#dc2626' : '#0369a1'}; border: 1px solid ${isOverdue ? '#fecaca' : '#bae6fd'}; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">
                                        <i class="fas fa-calendar" style="margin-right: 4px;"></i>${dueDateText}${isOverdue ? ' (Overdue)' : ''}
                                    </span>` : ''}
                                    
                                    <!-- Status Tag -->
                                    <span style="background: ${task.status === 'completed' ? '#dcfce7' : task.status === 'in-progress' ? '#fef3c7' : '#f1f5f9'}; color: ${task.status === 'completed' ? '#166534' : task.status === 'in-progress' ? '#92400e' : '#475569'}; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase;">
                                        ${task.status === 'completed' ? '✓' : task.status === 'in-progress' ? '⏳' : '📋'} ${task.status || 'scheduled'}
                                    </span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; margin-left: 12px;" onclick="event.stopPropagation();">
                                <button onclick="quickUpdateTask('${task.id}')" style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;" title="Add Quick Comment">
                                    <i class="fas fa-comment"></i>
                                </button>
                                <button onclick="editTask('${task.id}')" style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        window.showMyTasksByFilter = function(filter) {
            currentMyTaskFilter = filter;
            // Update filter title
            const filterTitle = document.getElementById('my-tasks-filter-title');
            if (filterTitle) {
                const titles = {
                    'all': 'My Tasks',
                    'scheduled': 'My Scheduled Tasks',
                    'in-progress': 'My In Progress Tasks',
                    'completed': 'My Completed Tasks'
                };
                filterTitle.textContent = titles[filter] || 'My Tasks';
            }
            renderMyTasksList(filter);
        }
        
        console.log('TaskManager initialized');
    </script>
</body>
</html>